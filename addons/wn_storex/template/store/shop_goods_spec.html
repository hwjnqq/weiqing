{template 'common/header-storex'}
<div class="wn-main wn-main--without">
	<div class="wn-main__head">
		<a href="{php echo $this->createWebUrl('shop_goodsmanage', array('storeid' => $storeid));}" id="add_coupon" >
			管理商品
		</a>
			/编辑规格
	</div>
	<div class="wn-main__content" id="goods_spec">
		<form action="{php echo $this->createWebUrl('shop_goods_spec', array('storeid' => $storeid,'op' => post));}" class="form-horizontal form" method="post" enctype="multipart/form-data">
			<input type="hidden" name="id" value="{$store['id']}">
			<input type="hidden" name="store_type" value="{$store['store_type']}">
			<div class="form-group">
				<label class="col-xs-12 col-sm-3 col-md-2 control-label">商品</label>
				<div class="col-sm-8 col-lg-9 col-xs-12">
					<input type="text" disabled value="{$store['title']}/{$category_info['name']}/{$goods_info['title']}" class="form-control">
				</div>
			</div>
			<template v-for="(spec, id) in spec_list">
				<div class="form-group">
					<div class="control-label col-sm-2">
						<input type="text" :value="spec.name" :name="'sp_name['+ id +']'" class="hidden" style="display: inline-block;width: 50%" v-model="sp_name[id]" >
						{{sp_name[id]}}
					</div>
					<div class="col-sm-8 col-lg-9 col-xs-12">
						<label class="checkbox-inline" v-for="value in spec.values">
							<input type="checkbox"
							       :value="value"
							       v-model="sp_value[id]"  /> {{value.name}}
						</label>
						<template class="hidden" v-for="(item, id) in sp_value">
							<input type="text" class="hidden" :id="'sp_val[' + id + '][' + value.id + ']'"
							       :name="'sp_val[' + id + '][' + value.id + ']'" :value="value.name" v-for="value in item">
						</template>

					</div>
				</div>
			</template>
			<div class="form-group">
				<label class="col-sm-3 control-label">库存配置</label>
				<div class="col-sm-9 col-xs-12">
					<table class="table we7-table">
						<thead>
							<tr>
								<th v-for="name in sp_name">{{name}}</th>
								<th>前台支付价</th>
								<th>在线支付价</th>
								<th>库存</th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="(sku, key) in skus" v-if="skus">

								<input type="hidden" :name="'spec[' + key + '][goods_id]'" value="12312" v-model="sku.goods_id" >
								<td v-for="item in sku.sp_value">
									{{item.name}}
									<input type="hidden" :name="'spec[' + key + '][sp_value][' + item.id + ']' " :value="item.name"  >
								</td>
								<td><input type="text" value="" :name="'spec[' + key + '][cprice]'" v-model="sku.cprice" ></td>
								<td><input type="text" value="" :name="'spec[' + key + '][oprice]'"  v-model="sku.oprice"></td>
								<td><input type="text" value="" :name="'spec[' + key + '][stock]'"  v-model="sku.stock"></td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
			<input type="submit" name="submit" value="提交" class="btn btn-primary" />
			<input type="hidden" name="token" value="{$_W['token']}">
		</form>
	</div>
</div>
{$spec_list}
<script type="text/javascript">
	require(['vue'], function (Vue) {
		var vm = new Vue({
			el: '#goods_spec',
			data: {
				spec_list: {php echo json_encode($spec_list)},
				sp_name: {},
				sp_value: [],
				skus: {},
				spec_num: 0
			},
			watch: {
				sp_value: {
					handler: function (val) {
						var args = []
						this.skus = {}
						for (var i in val) {
							if (val[i] && val[i].length > 0) {
								args.push(val[i])
							}
						}
						if (args.length === this.spec_num) {
							var skus = descartes(args)
							for(var i in skus) {
								var sku = {
									goods_id: '',
									oprice: '',
									cprice: '',
									stock: '',
									sp_value: []
								}
								sku.sp_value = skus[i].slice(0);
								var key = 'i';
								for (var j in skus[i]) {
									key = key + '_' + skus[i][j]['id']
								}
								this.skus[key] = sku
								this.skus = Object.assign({}, this.skus)
							}
						}
					},
					deep: true
				}
			},
			created: function () {
				var spec_list = {php echo json_encode($spec_list)};
				var sp_name = {}
				var sp_value = {}
				var lenght = 0
				for (var id in spec_list) {
					sp_name[id] = spec_list[id]['name']
					sp_value[id] = []
					lenght ++
				}
				this.spec_num = lenght
				this.$set(this, 'sp_value', sp_value)
				this.$set(this, 'sp_name', sp_name)
			}
		})
		// 笛卡儿积组合
		//循环方式组合
		function descartes(args){
			//var args = arguments;
			var rs   = [];
			// A. 校验并转换为JS数组
			for (var i = 0; i < args.length; i++) {
				if (!$.isArray(args[i])) {
					return false;  // 参数必须为数组
				}
			}

			// 两个笛卡尔积换算
			var bothDescartes = function (m, n){
				var r = []
				for (var i = 0; i < m.length; i++) {
					for (var ii = 0; ii < n.length; ii++) {
						var t = [];
						if ($.isArray(m[i])) {
							t = m[i].slice(0);  //此处使用slice目的为了防止t变化，导致m也跟着变化
						} else {
							t.push(m[i]);
						}
						t.push(n[ii]);
						r.push(t);
					}
				}
				return r;
			}
			if (args.length == 1) {
				for (var i in args[0]) {
					rs[i] = [args[0][i]]
				}
				return rs
			}
			// 多个笛卡尔基数换算
			for (var i = 0; i < args.length; i++) {
				if (i == 0) {
					rs = args[i];
				} else {
					rs = bothDescartes(rs, args[i]);
				}
			}
			return rs;
		}
	})
</script>
{template 'common/footer-storex'}