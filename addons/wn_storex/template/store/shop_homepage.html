{template 'common/header-storex'}
<link rel="stylesheet" href="../addons/wn_storex/template/style/css/membercard.css">
{if $op == 'display'}
<div class="wn-main wn-main--without">
	<div class="wn-main__head">店铺设置</div>
	<div class="wn-main__content">
		<div class="wn-home__module" id="app">
			<div class="app">
				<div class="app-preview">
					<div class="app-header"></div>
					<div class="app-content">
						<div class="title"><h1><span>首页</span></h1></div>
						<div>
							<div class="weui-tab">
								<div class="wn-home__preview">
									<draggable :list="openModules" element="div" :options="{group:'modules'}" :no-transition-on-drag="true" @start="drag=true;" @end="drag=false;" @change="moveEnd">
										<transition-group :name="!drag? 'list-complete' : null" :css="true">
											<div v-for="(open, index) in openModules" :key="open.type" class="wn-home__preview__item" :class="{'active': index === editModuleIndex}">
												<div @click="edit(index)" class="content">
													<div class="" v-if="open.type == 'search' && open.items && false">
														<div class="form-group">
															<input type="text" class="form-control" :placeholder="open.items" :value="open.items" disabled>
														</div>
													</div>
													<div class="image" v-else>
														<img :src="'../addons/wn_storex/template/style/img/home/' + open.type + '.png'">
													</div>
												</div>
												<div class="remove" v-on:click="removeModule(index)">
													移除
												</div>
											</div>
										</transition-group>
									</draggable>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="app-side">
					<div class="editor">
						<div class="wn-home__modules">
							<draggable :list="modules" element="div" :options="{group:{name:'modules', pull:'clone', put:false }}" :no-transition-on-drag="true" @start="drag=true;" @end="drag=false">
								<div v-for="(module, index) in modules" :key="index" class="wn-home__modules__item">
									<div @click="addModules(index)" class="content" :style="'background-image: url(../addons/wn_storex/template/style/img/home/' + module.type + '.png)'">
										{{typeValue[module.type]}}
									</div>
								</div>
							</draggable>
						</div>
						<div class="clearfix"></div>
						<div class="wn-home__edit" v-if="editModuleIndex">
							<h2 class="wn-home__edit__head">{{typeValue[openModules[editModuleIndex]['type']]}}</h2>
							<div class="wn-home__editSearch wn-home__edit__item" v-if="openModules[editModuleIndex]['type'] == 'search'">
								<div class="form-group">
									<input type="text" class="form-control" v-model.trim="openModules[editModuleIndex]['items']" placeholder="搜索框提示语">
								</div>
							</div>
							<div class="wn-home__editGoods row" v-if="openModules[editModuleIndex]['type'] == 'recommend'">
								<div class="col-sm-6">
									已选商品
									<draggable :list="openModules[editModuleIndex]['items']" element="div" :options="{group:{name:'goods'}}" :no-transition-on-drag="true" @start="drag=true" @end="drag=false" v-if="!showEdit && openModules[editModuleIndex]['items'].length > 0">
										<div class="media" v-for="(goods, index) in openModules[editModuleIndex]['items']">
											<div class="media-left">
												<a href="#">
													<img class="media-object" :src="goods.thumb" style="width: 60px; height: 60px; background-color: #666">
												</a>
											</div>
											<div class="media-body" style="width: 100%;">
												<h4 class="media-heading">{{goods.title}}</h4>
												<div>
													{{goods.cprice}}
													<button class="btn btn-primary btn-sm pull-right" @click="removeGood(index)">移除</button>
												</div>
											</div>
										</div>
									</draggable>
								</div>
								<div class="col-sm-6">
									<div class="form-group">
										<div class="input-group">
											<input type="text" class="form-control" v-model.trim="goodsParams" placeholder="商品搜索">
											<div class="input-group-btn">
												<button class="btn btn-default" @click="searchGoods"><i class="fa fa-search"></i></button>
											</div>
										</div>
									</div>
									<div class="media" v-for="goods in goodsList">
										<div class="media-left">
											<a href="#">
												<img class="media-object" :src="goods.thumb" style="width: 60px; height: 60px; background-color: #666">
											</a>
										</div>
										<div class="media-body" style="width: 100%;">
											<h4 class="media-heading">{{goods.title}}</h4>
											<div>
												{{goods.cprice}}
												<button class="btn btn-primary btn-sm pull-right" @click="addGood(goods)">添加</button>
											</div>
										</div>
									</div>
								</div>
								<div class="clearfix"></div>
							</div>
							<div class="wn-home__editImage" v-if="imageModules.indexOf(openModules[editModuleIndex]['type']) != -1">
								<div class="wn-home__editImage__item wn-home__editImage__item--slide" v-if="!showEdit">
									<div class="content row">
										<div class="col-sm-2">
											排序
										</div>
										<div class="col-sm-4" v-if="openModules[editModuleIndex]['type'] != 'notice'">
											图片
										</div>
										<div class="col-sm-3">
											标题
										</div>
										<div class="col-sm-3">
											链接
										</div>
									</div>
								</div>
								<draggable :list="openModules[editModuleIndex]['items']" element="div" :options="{group:{name:'slide'}}" :no-transition-on-drag="true" @start="drag=true" @end="drag=false" v-if="!showEdit && openModules[editModuleIndex]['items'].length > 0">
									<div v-for="(item, index) in openModules[editModuleIndex]['items']" :key="index" class="wn-home__editImage__item wn-home__editImage__item--slide">
										<div @click="editImage(index)" class="content row">
											<div class="col-sm-2">
												{{index}}
											</div>
											<div class="col-sm-4" v-if="openModules[editModuleIndex]['type'] != 'notice'">
												<img :src="item.img" alt="">
											</div>
											<div class="col-sm-3">
												<div class="text-over">{{item.title}}</div>
											</div>
											<div class="col-sm-3">
												<div class="text-over">{{item.url}}</div>
											</div>
										</div>
									</div>
								</draggable>
								<div @click="addImage()" v-show="!showEdit" class="btn btn-primary">点击添加</div>
								<div class="clearfix"></div>
								<div class="" v-if="showEdit">
									<h5>编辑</h5>
									<div class="form-group">
										<input type="text" class="form-control" v-model.trim="editValue.title" placeholder="标题">
										<div class="help-block">设置{{typeValue[openModules[editModuleIndex]['type']]}}标题</div>
									</div>
									<div class="form-group">
										<input type="text" class="form-control" v-model.trim="editValue.url" placeholder="链接">
										<div class="help-block">设置{{typeValue[openModules[editModuleIndex]['type']]}}链接</div>
									</div>
									<div class="form-group" v-if="openModules[editModuleIndex]['type'] != 'notice'">
										<div class="input-group">
											<input type="text" disabled class="form-control" v-model.trim="editValue.img" placeholder="图片地址">
											<span class="input-group-btn" @click="uploadImage(editValue, 'img')">
												<button class="btn btn-default" type="button"><i
														class="fa fa-plus-circle green"></i>&nbsp;选择图片</button>
											</span>
										</div>
										<div class="help-block">
											<img :src="editValue.img" alt="" style="width: 320px; height: auto">
										</div>
									</div>
									<div class="form-group">
										<a @click="showEdit = false" class="btn btn-default">取消</a>
										<a class="btn btn-primary" @click="saveEdit">保存</a>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="clearfix"></div>
			<div class="btn btn-primary" @click="submitModules">提交</div>
			<!--<div class="modal fade" tabindex="-1" role="dialog" :style="{display: showModal ? 'block' : 'none'}"  :class="{in: showModal}">-->
			<!--<div class="modal-dialog" role="document">-->
			<!--<div class="modal-content">-->
			<!--<div class="modal-header">-->
			<!--<button type="button" class="close" @click="showModal = false"><span>&times;</span></button>-->
			<!--<h4 class="modal-title">编辑</h4>-->
			<!--</div>-->
			<!--<div class="modal-body">-->
			<!--<div class="form-group">-->
			<!--<input type="text" class="form-control" v-model.trim="slideValue.url" placeholder="链接">-->
			<!--</div>-->
			<!--<div class="form-group">-->
			<!--<input type="text" class="form-control" v-model.trim="slideValue.title" placeholder="标题">-->
			<!--</div>-->
			<!--</div>-->
			<!--<div class="modal-footer">-->
			<!--<button type="button" class="btn btn-default" @click="showModal = false">取消</button>-->
			<!--<button type="button" class="btn btn-primary">保存</button>-->
			<!--</div>-->
			<!--</div>-->
			<!--</div>-->
			<!--</div>-->
		</div>
	</div>
</div>
<script>
	require({
		paths: {
			'Vue': '/addons/wn_storex/template/style/js/vue',
			'sortablejs': '/addons/wn_storex/template/style/js/Sortable.min',
			'vuedraggable': '/addons/wn_storex/template/style/js/vuedraggable.min'
		}
	})
	require(['bootstrap'])
	var default_module = {php echo json_encode($default_module)};
	var homepage = {php echo json_encode($homepage_list)};
	require(['Vue', 'vuedraggable'], function (Vue, vuedraggable) {
		Vue.component('draggable', vuedraggable);
		var vm = new Vue({
			el: '#app',
			name: 'Home',
			data: {
				drag: false,
				showEdit: false,
				typeValue: {
					search: '搜索框',
					slide: '幻灯片',
					notice: '公告',
					nav: '导航',
					cube: '魔方',
					adv: '广告条',
					recommend: '商品推荐'
				},
				imageModules: ['slide', 'nav', 'cube', 'adv', 'notice'],
				modules: default_module,
				openModules: homepage,
				editModuleIndex: '',
				editValue: {},
				editIndex: '',
				goodsParams: '',
				goodsList: []
			},
			methods: {
				removeModule: function (index) {
					var self = this;
					self.openModules.splice(index, 1);
					if (index == this.editModuleIndex) {
						self.editModuleIndex = ''
					} else if (index < this.editModuleIndex) {
						self.editModuleIndex--
					}
				},
				addModules: function (index) {
					var self = this;
					// Remove job from GUI
					self.openModules.push(self.modules[index])
				},
				moveEnd: function (evt) {
					// 新增
					if (evt.hasOwnProperty('added')) {
						if(evt.added.newIndex <= this.editModuleIndex) {
							this.editModuleIndex++
						}
					} else if (evt.hasOwnProperty('moved')) {
						if (evt.moved.oldIndex == this.editModuleIndex) {
							this.editModuleIndex = evt.moved.newIndex
						} else if (evt.moved.oldIndex > this.editModuleIndex && evt.moved.newIndex <= this.editModuleIndex) {
							this.editModuleIndex++
						} else if (evt.moved.oldIndex < this.editModuleIndex && evt.moved.newIndex >= this.editModuleIndex) {
							this.editModuleIndex--
						} else {
							console.log(evt)
						}
					} else {
						console.log(evt)
					}

				},
				edit: function (index) {
					var self = this;
					self.editModuleIndex = index;
					self.showEdit = false;
				},
				addImage: function () {
					this.showEdit = true;
					this.editValue = {
						url: '',
						img: '',
						title: ''
					}
				},
				editImage: function (index) {
					this.showEdit = true;
					this.editValue = {
						img: this.openModules[this.editModuleIndex]['items'][index]['img'],
						title: this.openModules[this.editModuleIndex]['items'][index]['title'],
						url: this.openModules[this.editModuleIndex]['items'][index]['url'],
					};
					this.editIndex = index;
				},
				hideEdit: function () {
					this.showEdit = false;
				},
				saveEdit: function () {
					var index = this.editModuleIndex;
					var value = this.editValue;
					for (var key in value) {
						if (value[key] === '') {
							util.message('表单错误', '', 'error');
							return;
						}
					}
					if (!this.editIndex && typeof this.editIndex != 'number') {
						this.openModules[index]['items'].push(value)
					} else {
						this.openModules[index]['items'][this.editIndex] = value
					}
					this.showEdit = false;
				},
				uploadImage: function (target, key) {
					const self = this;
					require(['fileUploader'], function (uploader) {
						uploader.show(function (img) {
							self.$set(target, key, img.url)
						}, {
							'direct': true,
							'multiple': false
						});
					});
				},
				searchGoods: function () {
					const self = this;
					$.post("{php echo $this->createWebUrl('shop_homepage', array('op' => 'search_goods', 'storeid' => $_GPC['storeid']))}", {title: this.goodsParams}, function (data) {
						data = $.parseJSON(data);
						if (data.message.errno != 0) {
							util.message(data.message.message, '', 'error');
						} else {
							console.log(data.message.message)
							self.goodsList = data.message.message
						}
					});
				},
				addGood: function (goods) {
					var index = this.editModuleIndex;
					var goodsList = this.openModules[index]['items'];
					for (var key in goodsList) {
						if(goodsList[key]['id'] == goods.id) {
							return ;
						}
					}
					this.openModules[index]['items'].push(goods)
				},
				removeGood: function (index) {
					this.openModules[this.editModuleIndex]['items'].splice(index, 1);
				},
				submitModules: function () {
					$.post("{php echo $this->createWebUrl('shop_homepage', array('op' => 'post', 'storeid' => $_GPC['storeid']))}", {params: this.openModules}, function (data) {
						data = $.parseJSON(data);
						if (data.message.errno != 0) {
							console.log(data)
							util.message(data.message.message, '', 'error');
						} else {
							util.message('编辑成功', '', 'success');
						}
					});
				}
			},
			watch: {
				'showEdit': function (value) {
					if (!value) {
						this.editValue = {};
						this.editIndex = '';
					}
				},
				'editModuleIndex': function (index) {
					if (this.openModules[index] && typeof this.openModules[index]['items'] != 'object') {
						this.openModules[index]['items'] = []
					}
				}
			},
			created: function () {
				this.editModuleIndex = 6;
			}
		})
	})
</script>
{/if}

{template 'common/footer-storex'}