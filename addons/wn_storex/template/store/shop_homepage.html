{template 'common/header-storex'}
<link rel="stylesheet" href="../addons/wn_storex/template/style/css/membercard.css">
{if $op == 'display'}
<div class="wn-main wn-main--without">
	<div class="wn-main__head">店铺设置</div>
	<div class="wn-main__content">
		<div class="wn-home__module" id="app">
			<div class="app">
				<div class="app-preview">
					<div class="app-header"></div>
					<div class="app-content">
						<div class="title"><h1><span>首页</span></h1></div>
						<div>
							<div class="weui-tab">
								<div class="wn-home__preview">
									<draggable :list="openModules" element="div" :options="{group:'modules'}" :no-transition-on-drag="true" @start="drag=true;" @end="drag=false;"  @change="moveEnd">
										<transition-group :name="!drag? 'list-complete' : null" :css="true">
											<div v-for="(open, index) in openModules" :key="open.type" class="wn-home__preview__item" :class="{'active': index == editModule.index}">
												<div @click="edit(index)" class="content">
													<div class="" v-if="open.type == 'search' && open.items && false">
														<div class="form-group">
															<input type="text" class="form-control" :placeholder="open.items" :value="open.items" disabled>
														</div>
													</div>
													<div class="image" v-else>
														<img :src="'../addons/wn_storex/template/style/img/home/' + open.type + '.png'" alt="">
													</div>
												</div>
												<div class="remove" v-on:click="removeModule(index)">
													<i class="fa fa-remove"></i>
												</div>
											</div>
										</transition-group>
									</draggable>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="app-side">
					<div class="editor">
						<div class="wn-home__modules">
							<draggable :list="modules" element="div" :options="{group:{name:'modules', pull:'clone', put:false }}" :no-transition-on-drag="true" @start="drag=true;" @end="drag=false">
								<div v-for="(module, index) in modules" :key="index" class="wn-home__modules__item" >
									<div @click="addModules(index)" class="content" :style="'background-image: url(../addons/wn_storex/template/style/img/home/' + module.type + '.png)'">
										{{typeValue[module.type]}}
									</div>
								</div>
							</draggable>
						</div>
						<div class="clearfix"></div>
						<div class="wn-home__edit">
							<h2 class="wn-home__edit__head">{{typeValue[editModule['type']]}}</h2>
							<div class="wn-home__editSearch wn-home__edit__item" v-if="editModule.type == 'search'">
								<div class="form-group">
									<input type="text" class="form-control" v-model.trim="openModules[editModule.index]['items']" placeholder="搜索框提示语">
								</div>
							</div>
							<div class="wn-home__editImage" v-if="imageModules.indexOf(editModule.type) != -1">
								<div class="wn-home__editImage__item wn-home__editImage__item--slide" v-if="!showEdit">
									<div class="content row">
										<div class="col-sm-2">
											排序
										</div>
										<div class="col-sm-4">
											图片
										</div>
										<div class="col-sm-3">
											标题
										</div>
										<div class="col-sm-3">
											链接
										</div>
									</div>
								</div>
								<draggable :list="openModules[editModule.index]['items']" element="div" :options="{group:{name:'slide'}}" :no-transition-on-drag="true" @start="drag=true" @end="drag=false" v-if="!showEdit">
									<div v-for="(item, index) in openModules[editModule.index]['items']" :key="index" class="wn-home__editImage__item wn-home__editImage__item--slide">
										<div @click="editImage(index)" class="content row">
											<div class="col-sm-2">
												{{index}}
											</div>
											<div class="col-sm-4">
												<img :src="item.img" alt="">
											</div>
											<div class="col-sm-3">
												<div class="text-over">{{item.title}}</div>
											</div>
											<div class="col-sm-3">
												<div class="text-over">{{item.url}}</div>
											</div>
										</div>
									</div>
								</draggable>
								<div @click="addImage()" v-show="!showEdit" class="btn btn-primary">点击添加</div>
								<div class="clearfix"></div>
								<div class="" v-if="showEdit">
									<h5>编辑</h5>
									<div class="form-group">
										<input type="text" class="form-control" v-model.trim="editValue.url" placeholder="链接">
									</div>
									<div class="form-group">
										<input type="text" class="form-control" v-model.trim="editValue.title" placeholder="标题">
									</div>
									<div class="form-group">
										<div class="input-group">
											<input type="text" disabled class="form-control" v-model.trim="editValue.img" placeholder="图片地址">
											<span class="input-group-btn" @click="uploadImage(editValue, 'img')">
												<button class="btn btn-default" type="button"><i class="fa fa-plus-circle green"></i>&nbsp;选择图片</button>
											</span>
										</div>
										<div class="help-block">
											<img :src="editValue.img" alt="" style="width: 320px; height: auto">
										</div>
									</div>
									<div class="form-group">
										<a @click="showEdit = false" class="btn btn-default">取消</a>
										<a class="btn btn-primary" @click="saveEdit">保存</a>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="clearfix"></div>
			<div class="btn btn-primary" @click="submitModules">提交</div>
			<!--<div class="modal fade" tabindex="-1" role="dialog" :style="{display: showModal ? 'block' : 'none'}"  :class="{in: showModal}">-->
				<!--<div class="modal-dialog" role="document">-->
					<!--<div class="modal-content">-->
						<!--<div class="modal-header">-->
							<!--<button type="button" class="close" @click="showModal = false"><span>&times;</span></button>-->
							<!--<h4 class="modal-title">编辑</h4>-->
						<!--</div>-->
						<!--<div class="modal-body">-->
							<!--<div class="form-group">-->
								<!--<input type="text" class="form-control" v-model.trim="slideValue.url" placeholder="链接">-->
							<!--</div>-->
							<!--<div class="form-group">-->
								<!--<input type="text" class="form-control" v-model.trim="slideValue.title" placeholder="标题">-->
							<!--</div>-->
						<!--</div>-->
						<!--<div class="modal-footer">-->
							<!--<button type="button" class="btn btn-default" @click="showModal = false">取消</button>-->
							<!--<button type="button" class="btn btn-primary">保存</button>-->
						<!--</div>-->
					<!--</div>-->
				<!--</div>-->
			<!--</div>-->
		</div>
	</div>
</div>
<script>
	require({
		paths: {
			'Vue': '/addons/wn_storex/template/style/js/vue',
			'sortablejs': '/addons/wn_storex/template/style/js/Sortable.min',
			'vuedraggable': '/addons/wn_storex/template/style/js/vuedraggable.min'
		}
	})
	require(['bootstrap'])
	require(['Vue', 'vuedraggable'], function (Vue, vuedraggable) {
		Vue.component('draggable', vuedraggable);
		var vm = new Vue({
			el: '#app',
			name: 'Home',
			data: {
				drag: false,
				showEdit: false,
				typeValue: {
					search: '搜索框',
					slide: '幻灯片',
					notice: '公告',
					nav: '导航',
					cube: '魔方',
					adv: '广告条',
					recommend: '商品推荐'
				},
				imageModules: ['slide', 'nav', 'cube', 'adv'],
				modules: [
					{
						type: "search",
						items: []
					},
					{
						type: "slide",
						items: []
					},
					{
						type: "notice",
						items: []
					},
					{
						type: "nav",
						items: []
					},
					{
						type: "cube",
						items: []
					},
					{
						type: "adv",
						items: []
					},
					{
						type: "recommend",
						items: []
					}
				],
				openModules: [
					{
						type: "search",
						item: []
					},
					{
						type: "slide",
						items: []
					},
					{
						type: "notice",
						items: []
					},
					{
						type: "nav",
						items: []
					},
					{
						type: "cube",
						items: []
					},
					{
						type: "adv",
						items: []
					},
					{
						type: "recommend",
						items: []
					}
				],
				editModule: {
					index: 1,
					type: 'slide',
					items: []
				},
				editValue: {},
				editIndex: ''
			},
			methods: {
				removeModule: function (index) {
					var self = this;
					// Remove job from GUI
					console.log(index)
					self.openModules.splice(index, 1);
					self.editModule = {}
				},
				addModules: function (index) {
					var self = this;
					// Remove job from GUI
					self.openModules.push(self.modules[index])
				},
				moveEnd: function (evt) {
					if(evt.moved.oldIndex == this.editModule.index) {
						this.editModule.index = evt.moved.newIndex
					}
				},
				edit: function (index) {
					var self = this;
					var editModule =  {
						index: index,
						type: self.openModules[index]['type'],
						items: self.openModules[index]['items']
					};
					self.editModule = editModule;
				},
				addImage: function () {
					this.showEdit = true;
					this.editValue = {
						url: '',
						img: '',
						title: ''
					}
				},
				editImage: function (index) {
					this.showEdit = true;
					this.editValue = {
						img: this.openModules[this.editModule.index]['items'][index]['img'],
						title: this.openModules[this.editModule.index]['items'][index]['title'],
						url: this.openModules[this.editModule.index]['items'][index]['url'],
					};
					this.editIndex = index;
				},
				hideEdit: function () {
					this.showEdit = false;
				},
				saveEdit: function () {
					var index = this.editModule.index;
					var value = this.editValue;
					if(!this.editIndex && typeof this.editIndex != 'number') {
						this.openModules[index]['items'].push(value)
					} else {
						this.openModules[index]['items'][this.editIndex] = value
					}
					this.showEdit = false;
				},
				uploadImage: function(target, key) {
					const self = this;
					require(['fileUploader'], function(uploader) {
						uploader.show(function(img) {
							self.$set(target, key, img.url)
						}, {
							'direct': true,
							'multiple': false
						});
					});
				},
				submitModules: function () {
					console.log(this.openModules)
				}
			},
			watch: {
				'showEdit': function (value) {
					if(!value) {
						this.editValue = {};
						this.editIndex = '';
					}
				}
			}
		})
	})
</script>
{/if}

{template 'common/footer-storex'}