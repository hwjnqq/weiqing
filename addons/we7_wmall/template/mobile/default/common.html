{template 'template'}
<script type='text/javascript' src="../addons/we7_wmall/resource/app/js/laytpl.dev.js"></script>
<script type='text/javascript' src='../addons/we7_wmall/resource/app/js/light7.js' charset='utf-8'></script>
<script type='text/javascript' src='../addons/we7_wmall/resource/app/js/i18n/cn.js' charset='utf-8'></script>
<script type="text/javascript" src="../addons/we7_wmall/resource/app/js/light7-swiper.min.js"></script>
<script type="text/javascript" src="../addons/we7_wmall/resource/app/js/common.js"></script>
<script>
$(function(){
	$(document).on('click', '.home .select-tab a.button', function(){
		var flag = false;
		if($(this).hasClass('button-active')) {
			flag = true;
		}
		$('.home .select-tab a.button').removeClass('button-active');
		$('.home .drop-menu-list').hide();
		if(!flag) {
			$(this).addClass('button-active');
			$(this).next('.drop-menu-list').show();
		}
	});

	$(document).on("pageInit", "#page-app-store, #page-app-goods", function(e, id, page) {
		$(document).on('click', '#btn-favorite', function(){
			var uid = $(this).data('uid');
			if(!uid) {
				$.confirm('登陆后才可以收藏,现在去登陆?', function() {
					location.href = "{php echo murl('auth/login');}";
					return false;
				});
			}
			var id = $(this).data('id');
			if(!id) return false;
			var type = 'star';
			if($(this).hasClass('fa-favor-fill')) {
				type = 'cancel';
			}
			$.post("{php echo $this->createMobileUrl('mine', array('op' => 'favorite'));}", {id: id, type: type}, function(data){
				var result = $.parseJSON(data);
				if(result.message.errno != 0) {
					$.toast(result.message.message);
				} else {
					if(type == 'cancel') {
						$.toast('取消收藏成功', '', 1000);
					} else {
						$.toast('添加收藏成功', '', 1000);
					}
					location.reload();
				}
				return false;
			});
		});
	});

	$(document).on("pageInit", "#page-app-order", function(e, id, page) {
		var loading = false;
		$(page).on('infinite', '.infinite-scroll',function() {
			var $this = $(this);
			var id = $this.data('min');
			if(!id) return;
			if (loading) return;

			loading = true;
			$this.find('.infinite-scroll-preloader').removeClass('hide');
			$.post("{php echo $this->createMobileUrl('order', array('op' => 'more'))}", {id: id, time: timeStamp}, function(data){
				var result = $.parseJSON(data);
				$this.attr('data-min', result.message.min);

				if(!result.message.min) {
					$.detachInfiniteScroll($('.infinite-scroll'));
					$('.infinite-scroll-preloader').remove();
					return;
				}

				$this.find('.infinite-scroll-preloader').removeClass('hide');
				var gettpl = $('#tpl-order').html();
				loading = false;
				laytpl(gettpl).render(result.message.message, function(html){
					setTimeout(function() {
						$this.find('.order-list').append(html);
					}, 1000);
				});
			});
		});
	});

	/*取消订单*/
	$(document).on('click', '.order-cancel', function(){
		var id = $(this).data('id');
		$.confirm('确定取消该订单吗?', function () {
			$.post("{php echo $this->createMobileUrl('order', array('op' => 'cancel'))}", {id: id}, function(data) {
				var result = $.parseJSON(data);
				if(result.message.errno != 0) {
					$.toast(result.message.message);
				} else {
					$.toast('订单取消成功', location.href, 1000);
				}
				return false;
			});
		});
	})

	/*确认送达*/
	$(document).on('click', '.order-end', function(){
		var id = $(this).data('id');
		$.confirm('你确定收到该商家的外卖?', function () {
			$.post("{php echo $this->createMobileUrl('order', array('op' => 'end'))}", {id: id}, function(data) {
				var result = $.parseJSON(data);
				if(result.message.errno != 0) {
					$.toast(result.message.message);
				} else {
					$.toast('确认送达成功', location.href, 1000);
				}
				return false;
			});
		});
	});

	/*催单*/
	$(document).on('click', '.order-remind', function(){
		var id = $(this).data('id');
		$.post("{php echo $this->createMobileUrl('order', array('op' => 'remind'))}", {id: id}, function(data) {
			var result = $.parseJSON(data);
			if(result.message.errno != 0) {
				$.toast(result.message.message);
			} else {
				$.toast('进行催单成功');
			}
			return false;
		});
	});

	/*商品评价*/
	$(document).on("pageInit", "#page-app-add-comment", function(e, id, page) {
		$(document).on('click', '.star-outline label', function(){
			$(this).parent().find('.radio').prop('checked', false);
			$(this).prevAll().find('.radio').prop('checked', true);
			$(this).find('.radio').addClass('checked').prop('checked', true);
		});

		$(document).on('click', '.submit-com', function(){
			var $this = $(this);
			var order_id = $this.data('id');
			if($this.hasClass('disabled')) {
				return false;
			}
			$this.addClass('disabled');

			var params = {
				goods: {},
				id: order_id
			};
			$('.star-outline').each(function(){
				var name = $(this).data('name');
				var value = $(this).find('.radio.checked').val();
				params[name] = value;
			});
			if(!params.delivery_service) {
				$this.removeClass('disabled')
				$.toast('请评价配送服务');
				return false;
			}
			if(!params.goods_quality) {
				$this.removeClass('disabled')
				$.toast('请评价商品质量');
				return false;
			}
			var note = $.trim($('.note').val());
			if(!note) {
				$this.removeClass('disabled')
				$.toast('点评不能为空');
				return false;
			}
			params.note = note;
			$('.goods-list').each(function(){
				var id = $(this).data('id');
				params.goods[id] = $(this).find('.radio:checked').val();
			});
			$.post("{php echo $this->createMobileUrl('order', array('op' => 'comment'));}", params, function(data){
				var result = $.parseJSON(data);
				if(result.message.errno != 0) {
					$this.removeClass('disabled')
					$.toast(result.message.message);
				} else {
					$.toast('评价成功', "{php echo $this->createMobileUrl('order');}");
				}
				return false;
			});
		})
	});

	$(document).on("pageInit", "#page-app-my-comment", function(e, id, page) {
		var loading = false;
		$(page).on('infinite', '.infinite-scroll',function() {
			var $this = $(this);
			var id = $this.data('min');

			if(!id) return;
			if (loading) return;

			loading = true;
			$this.find('.infinite-scroll-preloader').removeClass('hide');
			$.post("{php echo $this->createMobileUrl('comment', array('op' => 'more'))}", {id: id}, function(data){
				var result = $.parseJSON(data);
				$this.data('min', result.message.min);

				if(!result.message.min) {
					$.detachInfiniteScroll($('.infinite-scroll'));
					$('.infinite-scroll-preloader').remove();
					return;
				}

				$this.find('.infinite-scroll-preloader').removeClass('hide');
				var gettpl = $('#tpl-my-comment').html();
				loading = false;
				laytpl(gettpl).render(result.message.message, function(html){
					setTimeout(function() {
						$this.find('.comment-list').append(html);
					}, 1000);
				});
			});
		});
	});

	$(document).on("pageInit", "#page-app-store-comment", function(e, id, page) {
		var loading = false;
		$(page).on('infinite', '.infinite-scroll',function() {
			var $this = $(this);
			var aid = $this.data('min');
			var sid = $this.data('sid');
			var type = $this.data('type');

			if(!id) return;
			if (loading) return;

			loading = true;
			$this.find('.infinite-scroll-preloader').removeClass('hide');
			$.post("{php echo $this->createMobileUrl('store', array('op' => 'comment'))}", {aid: aid, sid: sid, type: type}, function(data){
				var result = $.parseJSON(data);
				$this.data('min', result.message.min);

				if(!result.message.min) {
					$.detachInfiniteScroll($('.infinite-scroll'));
					$('.infinite-scroll-preloader').remove();
					return;
				}

				$this.find('.infinite-scroll-preloader').removeClass('hide');
				var gettpl = $('#tpl-store-comment').html();
				loading = false;
				laytpl(gettpl).render(result.message.message, function(html){
					setTimeout(function() {
						$this.find('.comment-list ul').append(html);
					}, 1000);
				});
			});
		});
	});
	$.init();
});
</script>