{template 'header'}
{if $op == 'post'}
<div class="page address">
	<header class="bar bar-nav common-bar-nav">
		<a class="icon fa fa-arrow-left pull-left" href="{php echo $this->createMobileUrl('address');}"></a>
		<h1 class="title">新增地址</h1>
		<button class="button button-link button-nav pull-right" id="btnSubmit">保存</button>
	</header>
	{template 'nav'}
	<div class="content">
		<input type="hidden" name="location_x" class="location_x" value="{$address['location_x']}"/>
		<input type="hidden" name="location_y" class="location_y" value="{$address['location_y']}"/>
		<div class="list-block">
			<ul>
				<li class="item-addr">
					<div class="item-content">
						<div class="item-inner">
							<div class="item-title label">收货地址</div>
							<div class="item-input">
								<label></label>
								<input type="text" placeholder="常营民族家园" name="address" class="paddress" value="{$address['address']}">
							</div>
						</div>
					</div>
				</li>
				<li>
					<div class="item-content">
						<div class="item-inner">
							<div class="item-title label">门牌号</div>
							<div class="item-input">
								<input type="text" placeholder="请输入门牌号等详细信息" name="number" class="number" value="{$address['address']}">
							</div>
						</div>
					</div>
				</li>
				<li class="item-li-one">
					<div class="item-content">
						<div class="item-inner">
							<div class="item-title label">联系人</div>
							<div class="item-input">
								<div class="meitem-input"><input type="text" name="realname" class="realname" placeholder="您的姓名" value="{$address['realname']}"></div>
								<div class="item-sex">
									<label class="label-checkbox item-content">
										<input type="radio" name="sex" value="先生" class="sex" {if $address['sex'] == '先生' || !$address['sex']}checked{/if}>
										<div class="item-media"><i class="icon icon-form-checkbox"></i></div>
										<div class="item-inner">
											<div class="item-title">先生</div>
										</div>
									</label>
									<label class="label-checkbox item-content">
										<input type="radio" name="sex" value="女士" class="sex" {if $address['sex'] == '女士'}checked{/if}>
										<div class="item-media"><i class="icon icon-form-checkbox"></i></div>
										<div class="item-inner">
											<div class="item-title">女士</div>
										</div>
									</label>
								</div>
							</div>
						</div>
					</div>
				</li>
				<li>
					<div class="item-content">
						<div class="item-inner">
							<div class="item-title label">手机号</div>
							<div class="item-input">
								<input type="text" name="mobile" class="mobile" placeholder="配送人员联系您的电话" value="{$address['mobile']}">
							</div>
						</div>
					</div>
				</li>
			</ul>
			{if !empty($address)}
				<div class="del-address">
					<a href="javascript:;" data-id="{$address['id']}" class="btnDel">删除该地址</a>
				</div>
			{/if}
		</div>
	</div>
</div>
{/if}

{if $op == 'list'}
<div class="page address-list">
	<header class="bar bar-nav">
		<a class="icon fa fa-arrow-left pull-left" href="{php echo $this->createMobileUrl('mine');}"></a>
		<h1 class="title">我的地址</h1>
		<a class="button button-link button-nav pull-right external" href="{php echo $this->createMobileUrl('address', array('op' => 'post', 'sid' => $_GPC['sid'], 'r' => $_GPC['r']));}">新增</a>
	</header>
	{template 'nav'}
	<div class="content">
		{if empty($addresses)}
			<div class="common-no-con">
				<img src= "{MODULE_URL}resource/app/img/address_no_con.png" alt="" />
				<p>您还没有送货地址，快去添加吧！</p>
			</div>
		{else}
			<div class="list-block">
				<ul>
					{loop $addresses $address}
					<li class="item-content">
						<div class="item-inner">
							<div class="row no-gutter">
								<div class="col-80 addressChecked" data-id="{$address['id']}">
									<div><span class="name">{$address['realname']}</span><span class="sex">{$address['sex']}</span><span class="tel">{$address['mobile']}</span></div>
									<div class="detail-address">{$address['address']}</div>
								</div>
								<div class="col-20 address-edit">
									<a class="external" href="{php echo $this->createMobileUrl('address', array('op' => 'post', 'id' => $address['id'], 'sid' => $_GPC['sid'], 'r' => $_GPC['r']));}"><img src="{MODULE_URL}resource/app/img/address_edit.png" alt="" /></a>
								</div>
							</div>
						</div>
					</li>
					{/loop}
				</ul>
			</div>
		{/if}
	</div>
</div>
{/if}
<script>
$(function(){
	var r = "{$_GPC['r']}";
	var return_url = "{php echo $this->createMobileUrl('submit', array('sid' => $_GPC['sid'], 'r' => 1, 'op' => 'index'));}";

	$('#btnSubmit').click(function(){
		if($(this).hasClass('disabled')) {
			return false;
		}
		var realname = $.trim($('.realname').val());
		if(!realname) {
			$.toast("联系人不能为空");
			return false;
		}
		var mobile = $.trim($('.mobile').val());
		var reg = /^1[34578][0-9]{9}$/;
		if(!reg.test(mobile)) {
			$.toast("手机号格式错误");
			return false;
		}
		var sex = $.trim($('.sex:checked').val());
		if(!sex) {
			$.toast("请选择性别");
			return false;
		}
		var address = $.trim($('.paddress').val());
		if(!address) {
			alert(0)
			$.toast("地址不能为空");
			return false;
		}
		var number = $('.number').val();
		var location_x = $('.location_x').val();
		var location_y = $('.location_y').val();
		var params = {
			realname: realname,
			mobile: mobile,
			sex: sex,
			address: address,
			number: number,
			location_x: location_x,
			location_y: location_y
		};
		$(this).addClass('disabled');
		$.post("{php echo $this->createMobileUrl('address', array('op' => 'post', 'id' => $id))}", params, function(data) {
			var result = $.parseJSON(data);
			if(result.message.errno != 0) {
				$(this).removeClass('disabled');
				$.toast(result.message.message);
			} else {
				if(r) {
					location.href = return_url + '&address_id='+result.message.message;
				} else {
					$.toast('修改成功,跳转中...');
					location.href = "{php echo $this->createMobileUrl('address', array('op' => 'list'))}";
				}
			}
			return false;
		});
	});

	$('.btnDel').click(function(){
		var id = $(this).data('id');
		if(!id) return false;
		$.confirm('确定删除该地址吗?', function () {
			$.post("{php echo $this->createMobileUrl('address', array('op' => 'del', 'id' => $id))}", {id: id}, function(data) {
				var result = $.parseJSON(data);
				if(result.message.errno != 0) {
					$.toast(result.message.message);
				} else {
					$.toast('删除成功', "{php echo $this->createMobileUrl('address', array('op' => 'list'))}", 1000);
				}
				return false;
			});
		});
	});

	if(r) {
		$('.addressChecked').click(function(){
			var address_id = $(this).data('id');
			if(address_id) {
				$.post("{php echo $this->createMobileUrl('address', array('op' => 'default', 'sid' => $_GPC['sid']))}", {'id':address_id},function(){
					location.href=return_url + '&address_id='+address_id;
				});
			}
			return false;
		});
	}
});
$.config = {router: false}
</script>
{template 'common'}
{template 'footer'}