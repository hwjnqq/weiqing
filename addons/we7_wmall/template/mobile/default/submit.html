{template 'header'}
<div class="page order-confirm">
	<header class="bar bar-nav">
		<a class="icon fa fa-arrow-left pull-left hide" href=""></a>
		<h1 class="title">提交订单</h1>
	</header>
	<nav class="bar bar-tab no-gutter order-bar">
		<div class="left open-popup open-shop-cart" data-popup=".popup-shop-cart">
			<span class="pull-left">
				已优惠
				<span>￥{$activityed['total']}</span>
			</span>
			<span class="pull-right">
				还需付
				<span class="sum">￥{php echo $cart['price'] - $activityed['total'];}</span>
			</span>
		</div>
		<div class="right text-center bg-orange" id="order-submit">确认下单</div>
		<!--<div class="right text-center bg-grey">确认下单</div>-->
	</nav>
	<div class="content">
		<form method="post" id="order-form" action="{php echo $this->createMobileUrl('order', array('sid' => $sid, 'op' => 'submit'));}">
			<input type="hidden" name="sid" value="{$sid}">
			<input type="hidden" name="address_id" id="address_id" value="{$address_id}">
			<input type="hidden" name="note" id="order-note" value="">
			<input type="hidden" name="delivery_time" id="delivery-time" value="">
			<input type="hidden" name="delivery_day" id="delivery-day" value="">
			<div class="list-block address">
				<ul>
					<li>
						<a class="item-link item-content external" href="{php echo $this->createMobileUrl('address', array('sid' => $sid, 'r' => 1));}">
							<div class="item-inner">
								{if !empty($address)}
									<div class="item-text">
										<div><span class="name">{$address['realname']}</span><span class="tel">{$address['mobile']}</span></div>
										<div>地址:{$address['address']}</div>
									</div>
								{else}
									<div class="item-title">请选择送达地址</div>
								{/if}
							</div>
						</a>
						<div class="top-line"></div>
					</li>
				</ul>
			</div>
			<div class="content-block-title">选择支付方式 <span class="color-warning hide">（在线支付立减5元）</span></div>
			<div class="list-block media-list pay-method">
				<ul>
					{loop $store['payment'] $row}
						<li>
							<label class="label-checkbox item-content">
								<div class="item-inner">
									<div class="item-title">{$pay_types[$row]['text']}</div>
								</div>
								<input type="radio" name="pay_type" class="pay_type" value="{$row}" {if $row == 'wechat'}checked{/if}>
								<div class="item-media"><i class="icon icon-form-checkbox"></i></div>
							</label>
						</li>
					{/loop}
				</ul>
			</div>
			<div class="list-block hide">
				<ul>
					<li>
						<a href="#" class="item-link item-content">
							<div class="item-inner">
								<div class="item-title">代金券</div>
								<div class="item-after color-orange">无可用代金券无可用代金券无可用代金券无可用代金券无可用代金券无可用代金券</div>
							</div>
						</a>
					</li>
				</ul>
			</div>
			<div class="list-block">
				<ul>
					<li>
						<a href="#" class="item-link item-content delivery-time">
							<div class="item-inner">
								<div class="item-title">送达时间</div>
								<div class="item-after"><span class="color-black" id="delivery-time-show">立即送达</span><span class="color-orange hide">(大约12:00到)</span></div>
							</div>
						</a>
					</li>
					<li>
						<a class="item-link item-content">
							<div class="item-inner">
								<div class="item-title">备注</div>
								<div class="item-after order-note" id="order-note-show">(选填)可填入特殊要求</div>
							</div>
						</a>
					</li>
					{if $store['invoice_status']}
					<li>
						<div class="item-content invoice">
							<div class="item-inner">
								<div class="item-title">需要发票</div>
								<div class="item-after">
									<label class="label-switch invoice-status">
										<input type="checkbox" value="1">
										<div class="checkbox"></div>
									</label>
								</div>
							</div>
						</div>
					</li>
					{/if}
					<li class="hide invoice-value">
						<div class="item-content">
							<input type="text" id="invoice" placeholder="输入个人或者公司抬头"/>
						</div>
					</li>
				</ul>
			</div>
			<div class="list-block detail-info">
				<ul>
					<li>
						<div class="item-content">
							<div class="item-inner">
								<div class="item-title">{$store['title']}</div>
								<div class="item-after">本单由 <span class="color-black">商家</span> 配送</div>
							</div>
						</div>
					</li>
					<li class="order-list">
						<div class="inner-con">
							{loop $cart['data'] $val}
								{loop $val $val1}
									<div class="row no-gutter">
										<div class="col-60">{$val1['title']}</div>
										<div class="col-20 text-right color-muted">×{$val1['num']}</div>
										<div class="col-20 text-right color-black">￥{$val1['price']}</div>
									</div>
								{/loop}
							{/loop}
						</div>
					</li>
					<li class="order-list">
						<div class="inner-con">
							<div class="row no-gutter">
								<div class="col-80">包装费</div>
								<div class="col-20 text-right color-black">￥{$store['pack_price']}</div>
							</div>
							<div class="row no-gutter">
								<div class="col-80">配送费</div>
								<div class="col-20 text-right color-black">￥{$store['delivery_price']}</div>
							</div>
						</div>
					</li>
					{if !empty($activityed['list'])}
						<li class="order-list">
							<div class="inner-con">
								{loop $activityed['list'] $key $row}
									<div class="row no-gutter">
										<div class="col-80 icon-before"><img src="{MODULE_URL}resource/app/img/{$order_avtivitys[$key]['icon_b']}">{$row['name']}</div>
										<div class="col-20 text-right color-black">{$row['text']}</div>
									</div>
								{/loop}
							</div>
						</li>
					{/if}
					<li class="order-list">
						<div class="inner-con">
							<div class="row no-gutter">
								<div class="col-60 color-muted">订单 <span class="color-black">￥{$cart['price']}</span> - 优惠<span class="color-black">￥{$activityed['total']}</span></div>
								<div class="col-20 text-right color-muted">总计</div>
								<div class="col-20 text-right color-black">￥{php echo $cart['price'] - $activityed['total'];}</div>
							</div>
						</div>
					</li>
				</ul>
			</div>
		</form>
	</div>
</div>
<div class="modal modal-no-buttons delivery-time-modal">
	<div class="modal-inner">
		<div class="modal-title">
			<div>请选择送达时间</div>
		</div>
		<div class="modal-text">
			<div class="category-container">
				<div class="parent-category" id="delivery-time-parent">
					<ul>
						{loop $days $i $day}
							<li {if !$i}class="active"{/if} data-value="{$day}"><a href="javascript:;">{$day}</a></li>
						{/loop}
					</ul>
				</div>
				<div class="children-category" id="delivery-time-children">
					<div class="children-category-wrapper">
						<ul id="category1">
							{loop $times $i $time}
								<li data-value="{$time['start']} ~ {$time['end']}">
									<a href="javascript:;">{$time['start']} ~ {$time['end']}</a>
								</li>
							{/loop}
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<div class="popup popup-remark" id="popup-remark">
	<div class="content-block">
		<div class="popup-header row no-gutter">
			<div class="col-25"><a href=""><span class="fa fa-arrow-left"></span></a></div>
			<div class="col-50 text-center">填写备注</div>
			<div class="col-25 text-right"><a href="javascript:;" class="sure close-popup" id="note-submit">确定</a></div>
		</div>
		<div class="popup-body">
			<textarea name="" id="note-textarea" placeholder="给商家留言,可输入对商家的要求"></textarea>
			<div class="specs-select">
				<span class="spec-item">请提供餐具</span>
				<span class="spec-item">不吃辣</span>
				<span class="spec-item">微辣</span>
				<span class="spec-item">米饭多点</span>
				<span class="spec-item">没零钱</span>
			</div>
		</div>
	</div>
</div>
<script>
$(function(){
	$(document).on('click', '#order-submit', function(){
		var $this = $(this);
		if($(this).hasClass('bg-grey')) {
			return false;
		}
		$(this).removeClass('bg-orange').addClass('bg-grey');
		if(!$('#address_id').val()) {
			$(this).addClass('bg-orange').removeClass('bg-grey');
			$.toast('请选择收货地址');
			return false;
		}
		if(!$('.pay_type:checked').val()) {
			$(this).addClass('bg-orange').removeClass('bg-grey');
			$.toast('请选择支付方式');
			return false;
		}
		var params = {
			address_id: $('#address_id').val(),
			note: $('#order-note').val(),
			pay_type: $('.pay_type:checked').val(),
			invoice: $('#invoice').val()
		};
		$.post("{php echo $this->createMobileUrl('submit', array('sid' => $sid, 'op' => 'submit'));}", params, function(data){
			var result = $.parseJSON(data);
			if(result.message.errno != 0) {
				$(this).addClass('bg-orange').removeClass('bg-grey');
				$.toast(result.message.message);
			} else {
				$.toast('下单成功');
				location.href = "{php echo $this->createMobileUrl('pay', array('sid' => $sid));}&id=" + result.message.message;
			}
			return false;
		});
	});

	//选择时间
	$(document).on('click', '#delivery-time-show', function(){
		$.openModal('.delivery-time-modal', function(){
			$('.delivery-time-modal .children-category-wrapper').height(350);
			new IScroll('.delivery-time-modal .children-category-wrapper', {probeType: 3, mouseWheel: true, click: true})
		});
	});
	$(document).on('click', '#delivery-time-children li', function(){
		var day = $('#delivery-time-parent li.active').data('value');
		var time = $(this).data('value');
		$('#delivery-time').val(time);
		$('#delivery-day').val(day);
		$('#delivery-time-show').html(day + ' ' + time);
		$.icloseModal('.delivery-time-modal', true);
		return false;
	});
	$(document).on('click', '#delivery-time-parent li', function(){
		$(this).siblings().removeClass('active');
		$(this).addClass('active');
		return false;
	});

	//备注
	$(document).on('click', '#order-note-show', function(){
		$.popup('.popup-remark');
	});

	$(document).on('click', '#popup-remark .spec-item', function(){
		var note = $('#note-textarea').val();
		$('#note-textarea').val(note + ' ' + $(this).html());
	});

	$(document).on('click', '#note-submit', function(){
		var note = $('#note-textarea').val();
		if(note == '') {
			note = '(选填)可填入特殊要求';
		}
		$('#order-note-show').html(note);
		$('#order-note').val(note);
	});

	//发票
	$(document).on('click', '.invoice-status', function(){
		console.info(($(this).find('input').prop('checked')));
		if($(this).find('input').prop('checked')) {
			$('.invoice-value').removeClass('hide');
		} else {
			$('.invoice-value').addClass('hide');
		}
	});
});
</script>
{template 'common'}
{template 'footer'}