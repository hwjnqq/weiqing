(function (root, factory) {
	if (typeof define === 'function' && define.amd) {
		// AMD
		define(['underscore', 'webuploader', 'jquery.jplayer'], function (_, WebUploader) {
			return (root['fileUploader'] = factory(_, WebUploader));
		});
	} else if (typeof module === 'object' && typeof module.exports === 'object') {
		// commonJS
		module.exports = factory(require("underscore"),require("webuploader"),require("jquery.jplayer"),require("filestyle"));
	} else {
		// 普通引入：构造函数使用3个全局变量，但是还需要依赖 'jquery.jplayer', 'bootstrap', 'filestyle'
		root['fileUploader'] = factory(jQuery, underscore, WebUploader);
	}
})(window, function(_, WebUploader){
	var uploader = {
		'defaultoptions' : {
			direct : false,
			global : false,
			dest_dir : '',
			callback : null,
			type : 'image',
			mode : '',
			multiple : false,
			allowUploadVideo : true,
			fileSizeLimit: false,
			uploader : {
				//fileNumLimit: 30,
				//fileSizeLimit: 4 * 1024 * 1024,
				//fileSingleSizeLimit: 30* 4 * 1024 * 1024
			}
		},
		'uploader' : {},
		'upload' : function(options){
			var $this = this;
			$this.initOptions('', options);
			$this.initUploader('web', '#webUploaderBtn');
			options.isWechat = false;
			$this.initOptions('', options);
			$this.initUploader('web', '#webUploaderBtn2');
		},
		'show' : function(callback, options){
			return this.init(callback, options);
		},
		'initOptions' : function(callback, options){
			var $this = this;
			$this.options = $.extend({}, $this.defaultoptions, options);
			$this.options.callback = callback;
			if($this.options.isWechat){
				if($this.options.account_error) {
					alert('公众号没有上传素材的权限', '', 'info');
					return false;
				}
			} else {
				if($this.options.global){
					$this.options.global = 'global';
				} else {
					$this.options.global = '';
				}
				document.cookie = "__fileupload_type="+ escape ($this.options.type);
				document.cookie = "__fileupload_dest_dir="+ escape ($this.options.dest_dir);
				document.cookie = "__fileupload_global="+ escape ($this.options.global);
			}
		},
		'setOptions' : function(page,id){
			var $this = this, typeText, accept, fileNumLimit, fileSingleSizeLimit, fileSizeLimit, compress;
			if ($this.options.multiple) {
				fileNumLimit = isNaN(Number($this.options.num_limit)) ? 30 : Number($this.options.num_limit);
			}else{
				fileNumLimit = 1;
			}
			if($this.options.isWechat){
				fileSingleImageSizeLimit = 1 * 1024 * 1024;
				fileSingleVoiceSizeLimit = 5 * 1024 * 1024;
				fileSingleVideoSizeLimit = 5 * 1024 * 1024;
			}else{
				fileSingleImageSizeLimit = isNaN(Number($this.options.image_limit)) ? 5 * 1024 * 1024 : Number($this.options.image_limit);
				fileSingleVoiceSizeLimit = isNaN(Number($this.options.voice_limit)) ? 5 * 1024 * 1024 : Number($this.options.voice_limit);
				fileSingleVideoSizeLimit = isNaN(Number($this.options.video_limit)) ? 5 * 1024 * 1024 : Number($this.options.video_limit);
			}
			switch($this.options.type) {
				case 'image': 
					typeText = '图片';
					typeUnit = '张';
					accept = {
						title: 'Images',
						extensions: 'gif,jpg,jpeg,bmp,png,ico',
						mimeTypes: 'image/gif,image/jpg,image/jpeg,image/bmp,image/png,image/ico'
					};
					fileNumLimit = fileNumLimit;
					fileSingleSizeLimit = fileSingleImageSizeLimit;
					fileSizeLimit = fileNumLimit * fileSingleSizeLimit;
					compress = $this.options.isWechat ? {
						quality: 80,
						preserveHeaders: true,
						noCompressIfLarger: true,
						compressSize: 1 * 1024 * 1024
					} : false;
					break;
				case 'audio': 
				case 'voice': 
					typeText = '音频';
					typeUnit = '个';
					accept = {
						title: 'Audios',
						extensions: 'mp3,wma,wav,amr',
						mimeTypes: 'audio/*'
					};
					fileNumLimit = fileNumLimit;
					fileSingleSizeLimit = fileSingleVoiceSizeLimit;
					fileSizeLimit = fileNumLimit * fileSingleSizeLimit;
					compress = false;
					if ($this.options.isWechat) {
						fileNumLimit = 5;
						if($this.options.mode == 'temp'){
							accept.extensions = 'mp3';
							fileSingleSizeLimit = 2 * 1024 * 1024;
							fileSizeLimit = 5 * 2 * 1024 * 1024;
						}else{
							fileSingleSizeLimit = 5 * 1024 * 1024;
							fileSizeLimit = 5 * 5 * 1024 * 1024;
						}
					}
					break;
				case 'video':
					typeText = '视频';
					typeUnit = '个';
					accept = {
						title: 'Video',
						extensions: 'rm,rmvb,wmv,avi,mpg,mpeg,mp4',
						mimeTypes: 'video/*' 		// 这里不确定
					};
					fileNumLimit = fileNumLimit;
					fileSingleSizeLimit = fileSingleVideoSizeLimit;
					fileSizeLimit = fileNumLimit * fileSingleSizeLimit;
					compress = false;
					if ($this.options.isWechat) {
						fileNumLimit = 5;
						if($this.options.mode == 'temp'){
							accept.extensions = 'mp4';
							fileSingleSizeLimit = 10 * 1024 * 1024;
							fileSizeLimit = 5 * 10 * 1024 * 1024;
						}else{
							fileSingleSizeLimit = 20 * 1024 * 1024;
							fileSizeLimit = 5 * 20 * 1024 * 1024;
						}
					}
					break;
			}
			var options = {
				pick: {
					id: id,
					label: '<button class="btn btn-primary">'+ (page == 'window' ? '点击选择'+typeText : '上传到'+ ($this.options.isWechat ? '微信' : '服务器')) +'</button>',
					multiple : $this.options.multiple
				},
				auto : true,
				swf: './resource/componets/webuploader/Uploader.swf',
				server: $this.options.isWechat ? './index.php?c=utility&a=wechat_file&do=upload' : './index.php?c=utility&a=file&do=upload&type='+$this.options.type,
				compress: compress, 
				accept: accept,
				fileNumLimit: fileNumLimit,
				fileSizeLimit: fileSizeLimit,
				fileSingleSizeLimit: fileSingleSizeLimit,
				thumbnailWidth: 50,
				thumbnailHeight: 50,
			}
			// warning: 1.options是 'webUploader的上传配置'；2.$this.options是整个fileUploader的配置。注意区分开2者。注意区分开2者。注意区分开2者。注意区分开2者
			options = $.extend({}, options, $this.options.uploader);
			options.pick.multiple = $this.options.multiple;
			// 2个配置在下方需进行判别
			options.isWechat = $this.options.isWechat;
			options.type = $this.options.type;
			$this.options.fileNumLimit = fileNumLimit;
			$this.options.fileSizeLimit = fileSizeLimit;
			$this.options.fileSingleSizeLimit = fileSingleSizeLimit;
			$this.options.typeText = typeText;
			return options;
		},
		'init' : function(callback, options) {
			var $this = this;
			$this.initOptions(callback, options);
			$('#newUploaderImg').remove();
			if ($('#newUploaderImg').length == 0) {
				$(document.body).append($this.buildHtml().mainDialog);
			}
			$this.modalobj = $('#newUploaderImg');
			$this.modalobj.modal('show');
			$this.modalobj.on('shown.bs.modal', function(){
				if (!$(this).data('init')) {
					switch($this.options.type){
						case 'image':
						case 'thumb':
							$this.leftButtonClick('Local');
							break;
						case 'audio':
							$this.leftButtonClick('LocalAudio');
							break;
						case 'voice':
							$this.leftButtonClick('LocalVoice');
							break;
						case 'video':
							if($this.options.allowUploadVideo){
								$this.leftButtonClick('LocalVideo');
							}
							break;
					}
				}
			});
			return $this.modalobj;
		},
		'leftButtonClick' : function(name) {
			var $this = this;
			$this['init' + name]();
			$this.modalobj.find('.click_wechat').click(function(){
				$this.options.isWechat = true;
				$this['init' + name]();
			});
			$this.modalobj.find('.click_local').click(function(){
				$this.options.isWechat = false;
				$this['init' + name]();
			});
		},
		'initUploader' : function(page, id) {
			var $this = this;
			var options = $this.setOptions(page, id);
			var fileCount = 0;
			// 实例化
			uploader = WebUploader.create(options);
			uploader.option('server', uploader.option('server') + '&mode=perm&types=' + $this.options.type);
			uploader.on( 'uploadSuccess', function( file ) {
				fileCount--;
			    $( '#'+file.id ).addClass('upload-state-done');
			    if(fileCount == 0){
			    	if (page == 'window') {
			    		switch($this.options.type){
							case 'image':
							case 'thumb':
								$this.initLocal();
								break;
							case 'audio':
								$this.initLocalAudio();
								break;
							case 'voice':
								$this.initLocalVoice();
								break;
							case 'video':
								if($this.options.allowUploadVideo){
									$this.initLocalVideo();
								}
								break;
						}
			    	}else{
			    		window.location.reload();
			    	}
			    }
			});
			uploader.on( 'uploadComplete', function( file ) {
			    $( '#'+file.id ).find('.progress').remove();
			});
			uploader.onError = function( code ) {
				if(code == 'Q_EXCEED_SIZE_LIMIT'){
					alert('错误信息: '+$this.options.typeText+'大于 '+ WebUploader.formatSize($this.options.fileSizeLimit) +' 无法上传.');
					return
				}
				if(code == 'F_DUPLICATE'){
					alert('错误信息: 不能重复上传'+$this.options.typeText+'.');
					return
				}
				alert( 'Eroor: ' + code );
			};
			uploader.on( 'fileQueued', function( file ) {
				fileCount++;
			    var $li = $(
			            '<div id="' + file.id + '" class="file-item thumbnail">' +
			                '<img>' +
			                '<div class="info">' + file.name + '</div>' +
			            '</div>'
			            ),
			        $img = $li.find('img');
			    // $list为容器jQuery实例
			    if (page == 'window') {
			    	$('#newUploaderImg').find('.upload-queue').append( $li );
			    }else{
			    	$('.material-appmsg').find('.upload-queue').append( $li );
			    }
			    if($this.options.type == 'image'){
			    	uploader.makeThumb( file, function( error, src ) {
				        if ( error ) {
				            $img.replaceWith('<span>不能预览</span>');
				            return;
				        }

				        $img.attr( 'src', src );
				    }, $this.options.thumbnailWidth, $this.options.thumbnailHeight );
			    }
			});
			uploader.on( 'uploadProgress', function( file, percentage ) {
				var $li = $( '#'+file.id ),
		        	$percent = $li.find('.progress .progress-bar');
			    // 避免重复创建
			    if ( !$percent.length ) {
			        $percent = $('<div class="progress progress-striped active">' +
			          '<div class="progress-bar" role="progressbar" style="width: 0%">' +
			          '</div>' +
			        '</div>').appendTo( $li ).find('.progress-bar');
			    }

			    $li.find('p.state').text('上传中');

			    $percent.css( 'width', percentage * 100 + '%' );
			});
		},
		'initRemote' : function() {
			var $this = this;
			$this.modalobj.find('.tab-content').empty();
			$this.modalobj.find('.tab-content').append($this.buildHtml().remoteDialog);
			$this.modalobj.find('#btn-research').click(function(){
				var url = $this.modalobj.find('#networkurl').val();
				$.ajax({
					url: './index.php?c=utility&a=file&do=fetch', 
					data: "url="+url,
					dataType : 'json',
					success: function(result){
						if(result.message){
							alert(result.message);
						} else {
							$this.modalobj.find('.tab-content').find('.img').attr('style','background-image: url('+ result.url +');');
							$this.finish([result]);
							result = {};
						}
					}
				});
			});
		},
		'initVideoRemote' : function() {
			var $this = this;
			$this.modalobj.find('#li_network').removeClass('hide');
			$this.modalobj.find('.modal-body').append($this.buildHtml().remoteVideoDialog);
			$this.modalobj.find('#networkurl').blur(function(){
				var url = $(this).val();
				if (url.length > 0) {
					createPreviewVideo(url);
				} else {
					$('#preview').html('');	
				}
			});
			$this.modalobj.find('.btn-primary').click(function(){
				var url = $this.modalobj.find('#networkurl').val();
				if (url.length > 0 && $this.options.type == 'video'){
					// 远程获取视频地址
					var conUrl = convert_url(url);
					conUrl = unhtmlForUrl(conUrl);
					$this.finish([{'url' : conUrl, 'isRemote' : true}]);		// 添加一个isRemote，在百度编辑器中进行判断
				}
			});
			function createPreviewVideo(url){
				if ( !url )return;
				var conUrl = convert_url(url);
				conUrl = unhtmlForUrl(conUrl);
				$("#preview").html('<div style="position:absolute;top:0;margin:0;padding:120px 50px;width:100%;height:100%;font-size:20px;"><span>只支持 腾讯，优酷，土豆视频，如无法预览视频，请前往视频网址处的分享区域，复制通用地址到编辑器内部！</span></div>'+
				'<iframe src="'+conUrl+'" allowfullscreen="true" style="border:0;position:absolute;top:0;left:0;margin:0;padding:0;width:100%;height:100%;"></iframe>');
			}
			function convert_url(url){
				if ( !url ) return '';
				var id, iframe_url;
				if (url.indexOf('v.qq.com') >= 0) {
					id = url.match(/vid\=([^\&]*)($|\&)/);
					if	(id) {
						iframe_url = 'http://v.qq.com/iframe/player.html?vid='+id[1]+'&tiny=0&auto=0';
					} else {
						id = url.match(/\/([0-9a-zA-Z]+).html/);
						if(id) {
							iframe_url = 'http://v.qq.com/iframe/player.html?vid='+id[1]+'&tiny=0&auto=0';
						}
					}
					if (!id) {
						return;
					}
				} else if (url.indexOf('v.youku.com') >= 0) {
					id = url.match(/id_(.*)\.html/);
					iframe_url = 'http://player.youku.com/embed/' + id[1];
				} else if (url.indexOf('tudou.com') >= 0) {
					id = url.match(/\/([-\w]+)/g);
					id = id[id.length - 1].substring(1);
					iframe_url = 'http://www.tudou.com/programs/view/html5embed.action?code=' + id;
				} else {
					return;
				}
				return iframe_url;
			}
			function unhtmlForUrl(str, reg) {
				return str ? str.replace(reg || /[<">']/g, function (a) {
					return {
						'<':'&lt;',
						'&':'&amp;',
						'"':'&quot;',
						'>':'&gt;',
						"'":'&#39;'
					}[a]

				}) : '';
			}
		},
		'initLocal' : function() {
			var $this = this;
			$this.localPage(1);
		},
		'localPage' : function(page) {
			var $this = this;
			if($this.options.isWechat){
				var type = $this.options.type;
				var mode = $this.options.mode;
				var url = './index.php?c=utility&a=wechat_file&do=browser';
				var params = {'page': page, 'type' : type, 'mode' : mode, 'psize' : 10};
			}else{
				var year = $this.modalobj.find('#select-year .btn-info').data('id');
				var month = $this.modalobj.find('#select-month .btn-info').data('id');
				var url = './index.php?c=utility&a=file&do=local';
				var params = {'page': page, 'year': year, 'month': month};
			}
			var $history = $this.modalobj.find('.tab-content');
			$history.empty();
			$history.append($this.buildHtml().pickupDialog);
			$this.initUploader('window', '.btn.btn-upload-primary');
			$.getJSON(url, params, function(data){
				data = data.message.message;
				if(!_.isEmpty(data.items)) {
					$history.data('attachment', data.items);
					$history.find('.tablepanel-con').empty();
					$history.find('.tablepanel-con').html(_.template($this.buildHtml()[$this.options.isWechat ? 'weixin_localDialogLi' : 'localDialogLi'])(data));
					$history.find('#image-list-pager').html(data.page);
					$history.find('.pagination a').click(function(){
						$this.localPage($(this).attr('page'));
					});
					$history.find('.img').click(function(event){
						$this.selectImage($(event.target).parents('.item'));
					});
					if($this.options.isWechat){
						$this.weixinDeletefile();
					}else{
						$this.deletefile();
					}
				} else {
					$history.find('.tablepanel-con').html('<div class="empty hidden"><span class="wi wi-warning-sign"></span>暂无图片</div>');
				}
			});
			$this.modalobj.find('.modal-footer .text-center').find('.btn-primary').unbind('click').click(function(){
				var attachment = [];
				$history.find('.item.selected').each(function(){
					attachment.push($history.data('attachment')[$(this).attr('attachid')]);
					$(this).removeClass('selected');
				});
				$this.finish(attachment);
			});
			return false;
		},
		'deletefile' : function(){
			var $this = this;
			$this.modalobj.find('#history_image .img-list li .btnClose').unbind().click(function(){
				var $this = $(this);
				var id = $(this).data('id');
				if(!id) return false;
				$.post('./index.php?c=utility&a=file&do=delete', {id:id}, function(data){
					if(data != 'success') {
						alert(data);
					} else {
						$this.parent().remove();
						util.message('删除成功', '', 'success');
					}
				});
				return false;
			});
		},
		'weixinDeletefile' : function() {
			var $this = this;
			$this.modalobj.find('.tablepanel-con .delete-file').off('click');
			$this.modalobj.find('.tablepanel-con .delete-file').on('click', function(event){
				var $this = $(this);
				if (confirm("确定要删除文件吗？")){
					var id = $(this).parents('.audio-item').attr('attachid');
					var type =	$(this).parents('.audio-item').attr('data-type');
					$.post('./index.php?c=utility&a=wechat_file&do=delete', {'id' : id}, function(data){
						var data = $.parseJSON(data);
						if(!data.error) {
							util.message(data.message);
							return false;
						}
						if(type == 'image') {
							$this.parent().remove();
						} else if(type == 'audio' || type == 'voice' || type == 'video') {
							$this.parents('.audio-item').remove();
						}
					});
				}
				event.stopPropagation();
			});
		},
		'selectImage' : function(obj) {
			var $this = this;
			$(obj).toggleClass('selected', '');
			// 微信
			if($this.options.isWechat){
				if ($this.options.direct) {
			 		$this.modalobj.find('.modal-footer .text-center').find('.btn-primary').trigger('click');
				}
			}else{
				if (!$this.options.multiple) {
					$this.modalobj.find('.modal-footer .text-center').find('.btn-primary').trigger('click');
				}
			}
		},
		'initLocalAudio' : function() {
			var $this = this;
			$this.localAudioPage(1);
		},
		'localAudioPage' : function(page) {
			var $this = this;
			if($this.options.isWechat){
				var type = $this.options.type;
				var mode = $this.options.mode;
				var url = './index.php?c=utility&a=wechat_file&do=browser';
				var params = {'page': page, 'type' : type, 'mode' : mode, 'psize' : 5};
			}else{
				var url = './index.php?c=utility&a=file&do=local&type=audio&pagesize=5';
				var params = {'page': page};
			}

			var $history = $this.modalobj.find('.tab-content');
			$history.empty();
			$history.append($this.buildHtml().pickupDialog);
			$this.initUploader('window', '.btn.btn-upload-primary');
			$.getJSON(url, params, function(data){
				data = data.message.message;
				$history.find('.tablepanel-con').html('<i class="fa fa-spinner fa-pulse"></i>');
				if(!_.isEmpty(data.items)) {
					$history.data('attachment', data.items);
					$history.find('.tablepanel-con').empty();
					$history.find('.tablepanel-con').html(_.template($this.buildHtml()[$this.options.isWechat ? 'weixin_localAudioDialogLi' : 'localAudioDialogLi'])(data));
					$history.find('#image-list-pager').html(data.page);
					$history.find('.pagination a').click(function(){
						$this.localAudioPage($(this).attr('page'));
					});
					$history.find('.js-btn-select').click(function(event){
						$(event.target).toggleClass('btn-primary');
						// 微信
						if($this.options.isWechat){
							if ($this.options.direct) {
								$this.modalobj.find('#history_audio').find('.btn-primary').trigger('click');
							}
						}else{
							if (!$this.options.multiple) {
								$this.modalobj.find('#history_audio').find('.btn-primary').trigger('click');
							}
						}
					});
					$this.playAudio();
					//微信
					if($this.options.isWechat){
						$this.weixinDeletefile();
					}
				}else{
					$history.find('.history-content').css('text-align', 'center').html('<i class="fa fa-info-circle"></i> 暂无数据');
				}
			});
			$history.find('.modal-footer .btn-primary').unbind('click').click(function(){
				var attachment = [];
				$history.find('.history-content .btn-primary').each(function(){
					attachment.push($this.modalobj.find('#history_audio').data('attachment')[$(this).attr('attachid')]);
					$(this).removeClass('btn-primary');
				});
				$this.finish(attachment);
			});
			return false;
		},
		'playAudio' : function (){
			var $this = this;
			var $history = $this.modalobj.find('.tablepanel-con');
			$(".audio-player-play").click(function(){
				var src = $(this).attr("attach");
				if(!src) {
					return;
				}
				if ($("#player")[0]) {
					var player = $("#player");
				} else {
					var player = $('<div id="player"></div>');
					$(document.body).append(player);
				}
				player.data('control', $(this));
				player.jPlayer({
					playing: function() {
						$(this).data('control').find("p").removeClass("fa-play").addClass("fa-stop");
					},
					pause: function (event) {
						$(this).data('control').find("p").removeClass("fa-stop").addClass("fa-play");
					},
					swfPath: "resource/components/jplayer",
					supplied: "mp3,wma,wav,amr",
					solution: "html, flash",
				});
				player.jPlayer("setMedia", {mp3: $(this).attr("attach")}).jPlayer("play");
				if($(this).find("p").hasClass("fa-stop")) {
					player.jPlayer("stop");
				} else {
					$history.find('.fa-stop').removeClass("fa-stop").addClass("fa-play");
					player.jPlayer("setMedia", {mp3: $(this).attr("attach")}).jPlayer("play");
				}
			});
		},
		'initLocalVoice' : function() {
			this.initLocalAudio();	
		},
		'initLocalVideo' : function() {
			var $this = this;
			$this.localVideoPage(1);
		},
		'localVideoPage' : function(page) {
			var $this = this;
			if($this.options.isWechat){
				var type = $this.options.type;
				var url = './index.php?c=utility&a=wechat_file&do=browser';
				var params = {'page': page, 'type' : type, 'psize' : 5};
			}else{
				var url = './index.php?c=utility&a=file&do=local&type=video&pagesize=5';
				var params = {'page': page};
			}
			
			var $history = $this.modalobj.find('.tab-content');
			$history.empty();
			$history.append($this.buildHtml().pickupDialog);
			$this.initUploader('window', '.btn.btn-upload-primary');
			$.getJSON(url, params, function(data){
				data = data.message.message;
				$history.find('.history-content').html('<i class="fa fa-spinner fa-pulse"></i>');
				if(!_.isEmpty(data.items)) {
					$history.data('attachment', data.items);
					$history.find('.tablepanel-con').empty();
					$history.find('.tablepanel-con').html(_.template($this.buildHtml()[$this.options.isWechat ? 'weixin_localVideoDialogLi' : 'localVideoDialogLi'])(data));
					$history.find('#image-list-pager').html(data.page);
					$history.find('.pagination a').click(function(){
						$this.localVideoPage($(this).attr('page'));
					});
					$history.find('.js-btn-select').click(function(event){
						$(event.target).toggleClass('btn-primary');
						// 微信
						if($this.options.isWechat){
							if ($this.options.direct) {
								$this.modalobj.find('#history_video').find('.modal-footer .btn-primary').trigger('click');
							}
						}else{
							if (!$this.options.multiple) {
								$this.modalobj.find('#history_video').find('.modal-footer .btn-primary').trigger('click');
							}
						}
					});
					if($this.options.isWechat){
						$this.weixinDeletefile();
					}
				}else{
					$history.find('.history-content').css('text-align', 'left').html('<i class="fa fa-info-circle"></i> 暂无数据');
				}
			});
			$history.find('.modal-footer .btn-primary').unbind('click').click(function(){
				var attachment = [];
				$history.find('.history-content .btn-primary').each(function(){
					attachment.push($this.modalobj.find('#history_video').data('attachment')[$(this).attr('attachid')]);
					$(this).removeClass('btn-primary');
				});
				$this.finish(attachment);
			});
			return false;
		},
		'finish' : function(attachment) {
			var $this = this;
			if($.isFunction($this.options.callback)) {
				if ($this.options.multiple == false) {
					$this.options.callback(attachment[0]);
				} else {
					$this.options.callback(attachment);
				}
				$this.modalobj.modal('hide');
			}
		},
		'buildHtml' : function() {
			var dialog = {};
			dialog['mainDialog'] = '<div id="newUploaderImg" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">\n' +
				'	<div class="modal-dialog">\n' +
				'		<div class="modal-content">\n' +
				'			<div class="modal-header">\n' +
				'				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>\n' +
				'				上传\n' +
				'			</div>\n' +
				'			<div class="modal-body clearfix">\n' +
				'				<ul class="nav nav-pills nav-stacked">\n' +
				'					<li role="presentation"'+ (this.options.isWechat ? 'class="active"' : '') +'><a href="#wx" class="click_wechat" role="tab" data-toggle="tab">微信</a></li>\n' +
				'					<li role="presentation"'+ (this.options.isWechat ? '' : 'class="active"') +'><a href="#local" class="click_local" role="tab" data-toggle="tab">服务器</a></li>\n' +
				'				</ul>\n' +
				'				<div class="tab-content '+(this.options.type)+'"></div>\n' +
				'			</div>\n' +
				'			<div class="modal-footer">\n' +
				'				<div class="text-center">\n' +
				'					<span class="pull-left count"></span>\n' +
				'					<button '+(this.options.multiple ? '' : 'style="display:none;"')+' type="button" class="btn btn-primary" id="testbtn">确定</button>\n' +
				(this.options.multiple ? '<button type="button" class="btn btn-default"  data-dismiss="modal">取消</button>\n' : '') +
				'				</div>\n' +
				'			</div>\n' +
				'		</div>\n' +
				'	</div>\n' +
				'</div>';

			dialog['pickupDialog'] = '<div role="tabpanel" class="tab-pane active" id="wx">\n' +
				'						<div class="tablepanel-top text-right">\n' +
				'							<div class="upload-queue"></div>\n' +
				'							<span>建议尺寸：200像素 * 200像素</span>\n' +
				'							<div class="btn btn-upload-primary">选择文件</div>\n' +
				'						</div>\n' +
				'						<div class="tablepanel-con">\n' +
				'							<div class="img-list clearfix"></div>\n' +
				'						</div>\n' +
				'					</div>';
			
			dialog['remoteDialog'] = 
				'<div role="tabpanel" class="text-center clearfix" id="link">\n' +
				'	<div class="item">\n' +
				'		<div class="img" style="background-image: url(\'#\');">'+
				'			<span class="cover">\n' +
				'				<i class="wi wi-right"></i>\n' +
				'			</span>\n' +
				'		</div>\n' +
				'		<div class="img-title"></div>\n' +
				'	</div>\n' +
				'	<div class="text-center link">\n' +
				'		<div class="state">输入图片链接</div>\n' +
				'		<form action="" method="post">\n' +
				'			<input type="url" class="form-control text-center" id="networkurl" placeholder="请输入网络图片地址">\n' +
				'			<button id="btn-research" class="btn btn-default" type="submit">搜索</button>\n' +
				'		</form>\n' +
				'	</div>\n' +
				'</div>';
			
			dialog['remoteVideoDialog'] = '<div role="tabpanel" class="tab-pane network'+(!this.options.allowUploadVideo ? ' active' : ' ')+'" id="network">\n' +
				'	<div style="margin-top: 10px;">\n' +
				'		<form>\n' +
				'			<div class="form-group">\n' +
				'				<div style="margin: -10px 0 10px 0;">为了在微信中有更好的体验，推荐使用<a href="http://v.qq.com" target="_blank">腾讯视频</a></div>\n' +
				'				<input type="url" class="form-control" id="networkurl" placeholder="请输入网络视频地址">\n' +
				'				<div id="preview" style="position:relative;width:600px;height:300px;margin:0 auto;margin-top:15px;text-align:center;background:#ccc;">\n' +
				'				</div>\n' +
				'			</div>\n' +
				'		</form>\n' +
				'	</div>\n' +
				'	<div class="modal-footer" style="margin:0 -30px -30px;">\n' +
				'		<button type="button" class="btn btn-primary">确认</button>\n' +
				'		<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>\n' +
				'	</div>\n' +
				'</div>';
			
			dialog['localDialogLi'] = '<div class="img-list clearfix">\n' +
				'<%var items = _.sortBy(items, function(item) {return -item.id;});%>' +
				'<%_.each(items, function(item) {%> \n' +
				'	<div class="item" attachid="<%=item.id%>" title="<%=item.filename%>">\n' +
				'		<div class="img" style="background-image: url('+"'<%=item.url%>'"+');">\n' +
				'			<span class="cover">\n' +
				'				<i class="wi wi-right"></i>\n' +
				'			</span>\n' +
				'		</div>\n' +
				'		<div class="img-title"><%=item.filename%></div>\n' +
				'	</div>\n' +
				'<%});%>\n' +
				'</div>\n' +
				'<div class="text-right">' +
				'	<nav id="image-list-pager">\n' +
				'			<ul class="pager" style="margin: 0;"></ul>\n' +
				'	</nav>\n' +
				'</div>';
			
			dialog['weixin_localDialogLi'] = '<div class="img-list clearfix">\n' +
				'<%var items = _.sortBy(items, function(item) {return -item.id;});%>' +
				'<%_.each(items, function(item) {%> \n' +
				'	<div class="item" attachid="<%=item.id%>" title="<%=item.filename%>">\n' +
				'		<div class="img" style="background-image: url('+"'<%=item.url%>'"+');">\n' +
				'			<span class="cover">\n' +
				'				<i class="wi wi-right"></i>\n' +
				'			</span>\n' +
				'		</div>\n' +
				'		<div class="img-title"><%=item.filename%></div>\n' +
				'	</div>\n' +
				'<%});%>\n' +
				'</div>\n' +
				'<div class="text-right">' +
				'	<nav id="image-list-pager">\n' +
				'			<ul class="pager" style="margin: 0;"></ul>\n' +
				'	</nav>\n' +
				'</div>';
			
			dialog['localAudioDialog'] = '<div role="tabpanel" class="tab-pane history" id="history_audio">\n' +
				'	<div style="height:310px; overflow-x:hidden; overflow-y: auto;">\n' +
				'		<table class="table table-hover we7-table">\n' +
				'		<thead class="navbar-inner">\n' +
				'			<tr>\n' +
				'				<th>标题</th>\n' +
				(this.options.isWechat ? 
				'				<th style="width:30%;text-align:right">创建时间</th>\n' +
				'				<th style="width:30%;text-align:right">\n' +
				'					<div class="input-group input-group-sm hide">\n' :
				'				<th style="width:20%;">创建时间</th>\n' +
				'				<th style="width:30%;">\n' +
				'					<div class="input-group input-group-sm">\n') +
				'						<input type="text" class="form-control">\n' +
				'						<span class="input-group-btn">\n' +
				'							<button class="btn btn-default" type="button"><i class="fa fa-search" style="font-size:12px; margin-top:0;"></i></button>\n' +
				'						</span>\n' +
				'					</div>\n' +
				'				</th>\n' +
				'			</tr>\n' +
				'		</thead>\n' +
				'		<tbody class="history-content">\n' +
				'		</tbody>\n' +
				'	</table></div>\n' +
				'	<nav id="image-list-pager" class="text-right we7-margin-vertical">\n' +
				'		<ul class="pager" style="margin: 0;"></ul>\n' +
				'	</nav>\n' +
				'	<div class="modal-footer" style="margin:0 -30px -30px;">\n' +
				'		<div style="float: right;">\n' +
				'		<button '+(this.options.multiple ? '' : 'style="display:none;"')+' type="button" class="btn btn-primary">确认</button>\n' +
				(this.options.multiple ? '<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>\n' : '') +
				'		</div>\n' +
				'	</div>\n' +
				'</div>';
			
			dialog['localAudioDialogLi'] = '<div class="img-list clearfix">\n' +
				'<%var items = _.sortBy(items, function(item) {return -item.id;});%>' +
				'<%_.each(items, function(item) {%> \n' +
				'<div class="audio-item" attachid="<%=item.id%>" title="<%=item.filename%>" data-type="audio"><tr>\n' +
				'	<td><a href="#" title="<%=item.filename%>"><%=item.filename%></a></td>\n' +
				'	<td class="text-right"><%=item.createtime%></td>\n' +
				'	<td class="text-right">\n' +
				'		<span class="input-group-btn">\n' +
				'			<button class="btn btn-default audio-player-play" type="button" attach="<%=item.url%>"><p style="margin:0px;" class="fa fa-play"></p></button>\n' +
				'			<button attachid="<%=item.id%>" class="btn btn-default js-btn-select">选取</button>\n' +
				'		</span>\n' +
				'	</td>\n' +
				'</div></tr>\n' +
				'<%});%>\n' +
				'</div>' +
				'<div class="text-right">' +
				'	<nav id="image-list-pager">\n' +
				'			<ul class="pager" style="margin: 0;"></ul>\n' +
				'	</nav>\n' +
				'</div>';
			
			dialog['weixin_localAudioDialogLi'] = '<div class="img-list clearfix">\n' +
				'<%var items = _.sortBy(items, function(item) {return -item.id;});%>' +
					'<%_.each(items, function(item) {%> \n' +
					'<div class="audio-item" attachid="<%=item.id%>" title="<%=item.filename%>" data-type="audio"><tr>\n' +
					'	<td><a href="<%=item.url%>" target="blank" title="<%=item.filename%>"><%=item.filename%></a></td>\n' +
					'	<td class="text-right"><%=item.createtime%></td>\n' +
					'	<td class="text-right">\n' +
					'		<span class="input-group-btn" attachid="<%=item.id%>" data-type="audio">\n' +
					'			<button class="btn btn-default audio-player-play" type="button" attach="<%=item.url%>"><p style="margin:0px;" class="fa fa-play"></p></button>\n' +
					'			<button class="btn btn-default delete-file">删除</button>\n' +
					'			<button attachid="<%=item.id%>" class="btn btn-default js-btn-select">选取</button>\n' +
					'		</span>\n' +
					'	</td>\n' +
					'</tr></div>\n' +
					'<%});%>\n' +
					'</div>' +
					'<div class="text-right">' +
					'	<nav id="image-list-pager">\n' +
					'			<ul class="pager" style="margin: 0;"></ul>\n' +
					'	</nav>\n' +
					'</div>';
			
			dialog['localVideoDialog'] = '<div role="tabpanel" class="tab-pane history" id="history_video">\n' +
				'	<div style="height:310px; overflow-x:hidden; overflow-y:auto;">\n' +
				'		<table class="table table-hover we7-table">\n' +
				'		<thead class="navbar-inner">\n' +
				'			<tr>\n' +
				'				<th>标题</th>\n' +
				'				<th style="width:30%;text-align:right">创建时间</th>\n' +
				'				<th style="width:30%;text-align:right">\n' +
				'					<div class="input-group input-group-sm hide">\n' +
				'						<input type="text" class="form-control">\n' +
				'						<span class="input-group-btn">\n' +
				'							<button class="btn btn-default" type="button"><i class="fa fa-search" style="font-size:12px; margin-top:0;"></i></button>\n' +
				'						</span>\n' +
				'					</div>\n' +
				'				</th>\n' +
				'			</tr>\n' +
				'		</thead>\n' +
				'		<tbody class="history-content">\n' +
				'		</tbody>\n' +
				'	</table></div>\n' +
				'	<nav id="image-list-pager" class="text-right we7-margin-vertical">\n' +
				'		<ul class="pager" style="margin: 0;"></ul>\n' +
				'	</nav>\n' +
				'	<div class="modal-footer" style="margin:0 -30px -30px;">\n' +
				'		<div style="float: right;">\n' +
				'		<button '+(this.options.multiple ? '' : 'style="display:none;"')+' type="button" class="btn btn-primary">确认</button>\n' +
				(this.options.multiple ? '<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>\n' : '') +
				'		</div>\n' +
				'	</div>\n' +
				'</div>';
			
			dialog['localVideoDialogLi'] = '<div class="img-list clearfix">\n' +
				'<%var items = _.sortBy(items, function(item) {return -item.id;});%>' +
				'<%_.each(items, function(item) {%> \n' +
				'<div class="audio-item" attachid="<%=item.id%>" title="<%=item.filename%>" data-type="audio"><tr>\n' +
				'	<td><a href="#" title="<%=item.filename%>"><%=item.filename%></a></td>\n' +
				'	<td class="text-right"><%=item.createtime%></td>\n' +
				'	<td class="text-right">\n' +
				'		<span class="input-group-btn">\n' +
				'			<button attachid="<%=item.id%>" class="btn btn-default js-btn-select">选取</button>\n' +
				'		</span>\n' +
				'	</td>\n' +
				'</div></tr>\n' +
				'<%});%>\n' +
				'</div>' +
				'<div class="text-right">' +
				'	<nav id="image-list-pager">\n' +
				'			<ul class="pager" style="margin: 0;"></ul>\n' +
				'	</nav>\n' +
				'</div>';
			
			dialog['weixin_localVideoDialogLi'] = '<div class="img-list clearfix">\n' +
				'<%var items = _.sortBy(items, function(item) {return -item.id;});%>' +
					'<%_.each(items, function(item) {%> \n' +
					'<div class="audio-item" attachid="<%=item.id%>" title="<%=item.filename%>" data-type="audio"><tr>\n' +
					'	<td><a href="<%=item.url%>" target="blank" title="<%=item.filename%>"><%=item.filename%></a></td>\n' +
					'	<td class="text-right"><%=item.createtime%></td>\n' +
					'	<td class="text-right">\n' +
					'		<span class="input-group-btn" attachid="<%=item.id%>" data-type="audio">\n' +
					'			<button class="btn btn-default delete-file">删除</button>\n' +
					'			<button attachid="<%=item.id%>" class="btn btn-default js-btn-select">选取</button>\n' +
					'		</span>\n' +
					'	</td>\n' +
					'</div></tr>\n' +
					'<%});%>\n' +
					'</div>' +
					'<div class="text-right">' +
					'	<nav id="image-list-pager">\n' +
					'			<ul class="pager" style="margin: 0;"></ul>\n' +
					'	</nav>\n' +
					'</div>';

			return dialog;
		}
	};
	return uploader;
});