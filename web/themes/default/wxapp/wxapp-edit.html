{template 'common/header-base'}
<link rel="stylesheet" type="text/css" href="./resource/css/common.wxapp.css"/>
<body>
<div class="head">
	<nav class="navbar navbar-default" role="navigation">
		<div class="container">
			<div class="navbar-header">
				<a class="navbar-brand" href="#"><span class="color-default">微</span>擎 <span class="label label-versions">标准版</span></a>
			</div>
			<div class="collapse navbar-collapse">
				<ul class="nav navbar-nav navbar-left">
					<li class="active">
						<a href="#">公众号</a>
					</li>
					<li>
						<a href="#">应用市场</a>
					</li>
					<li>
						<a href="#">系统管理</a>
					</li>
					<li>
						<a href="#">功能帮助</a>
					</li>
				</ul>

				<ul class="nav navbar-nav navbar-right">
					<li>
						<a href="#">提醒</a>
					</li>
					<li class="dropdown">
						<a href="#" class="dropdown-toggle" data-toggle="dropdown">皮肤 <span class="caret"></span></a>
						<ul class="dropdown-menu" role="menu">
							<li>
								<a href="#">Action</a>
							</li>
							<li>
								<a href="#">Another action</a>
							</li>
							<li>
								<a href="#">Something else here</a>
							</li>
							<li class="divider"></li>
							<li>
								<a href="#">Separated link</a>
							</li>
						</ul>
					</li>
					<li class="dropdown">
						<a href="#" class="dropdown-toggle" data-toggle="dropdown">马德坤 <span class="caret"></span></a>
						<ul class="dropdown-menu" role="menu">
							<li>
								<a href="#">Action</a>
							</li>
							<li>
								<a href="#">Another action</a>
							</li>
							<li>
								<a href="#">Something else here</a>
							</li>
							<li class="divider"></li>
							<li>
								<a href="#">Separated link</a>
							</li>
						</ul>
					</li>
				</ul>
			</div>
		</div>
	</nav>
</div>
<div class="main" ng-controller="MainCtrl" ng-cloak>
	<div class="container">
		<div class="caret-wxapp">
			<div class="panel panel-app">
				<div class="wxapp-head panel-heading">
					<!--头部信息-->
					<img src="./resource/images/9.png" alt="公众号头像" class="">
					<span class="wxapp-name">第一个微擎小程序</span>
					<span class="wxapp-version">v0.0.1</span>
					<a href="{php echo url('wxapp/create/getpackage', array('uniacid' => $uniacid, 'versionid' => $versionid));}" class="color-default">打包下载</a>
					<!--end头部信息-->
				</div>
				<div class="panel-body">
					<div class="left-menu">
						<!--菜单列表-->
						<div class="panel panel-menu">
							<div class="panel-heading">
								首页设置<span class="fa fa-cog pull-right"></span>
							</div>
							<ul class="list-group">
								<li class="list-group-item" ng-class="{active : wxapp == 'slide'}" ng-click="wxapp = 'slide'">
									<a href=""><i class="fa fa-adjust"></i>幻灯片 </a>
								</li>
								<li class="list-group-item" ng-class="{active : wxapp == 'nav'}" ng-click="wxapp = 'nav'">
									<a href=""><i class="fa fa-adjust"></i>导航图标</a>
								</li>
								<li class="list-group-item" ng-class="{active : wxapp == 'recommend'}" ng-click="wxapp = 'recommend'">
									<a href=""><i class="fa fa-adjust"></i>推荐图片</a>
								</li>
							</ul>
						</div>
						<div class="panel panel-menu">
							<div class="panel-heading">
								模块
							</div>
							<ul class="list-group">
								{loop $modules $module}
								<a href="{php echo url('home/welcome/ext', array('m' => $module['name']))}">
									<li class="list-group-item">
										<i class="fa fa-adjust"></i>{$module['title']}
									</li>
								</a>
								{/loop}
							</ul>
						</div>
						<!--end菜单列表-->
					</div>
					<div class="right-contnt">
						<div class="wxapp-slide-project">
							<!--预览-->
							<div class="wxapp-phone">
								<img src="./resource/images/iphone6.png" alt="" class="wxapp-phone-bg" />
								<!--预览内容-->
								<div class="wxapp-home-preview">
									<img src="./resource/images/wxapp-default-tpl1.jpg"/>
								</div>
								<!--end预览内容-->
							</div>
							<!--end预览-->
							<div class="wxapp-slide">
								<!--列表-->
								<div class="wxapp-slide-list"  ng-show="wxapp == 'slide'">
									<div class="slide-heading">
										幻灯片
									</div>
									<ul>
										{loop $slides $slide}
										<li>
											<div class="wxapp-slide-detail media">
												<div class="media-left media-middle slide-sort">
													{$slide['displayorder']}
												</div>
												<div class="media-left media-middle slide-img">
													<img src="{php echo tomedia($slide['thumb'])}"/>
												</div>
												<div class="media-body">
													<div class="slide-title">
														{$slide['title']}
													</div>
													<div class="slide-alter">
														<a href="" ng-click="slideedit({$slide['id']})" class="color-default">编辑</a>
														<a href="{php echo url('wxapp/manage/edit', array('id' => $slide['id'], 'operate' => 'delete', 'type' => 'slide', 'multiid' => $multiid))}" onclick="return confirm('确认删除幻灯片吗');" class="color-default">删除</a>
													</div>
												</div>
											</div>
										</li>
										{/loop}
										<li class="slide-list-more">
											<a href=""  class="slide-add" ng-click="slideedit('add')">+</a>
										</li>
									</ul>
								</div>
								<div class="wxapp-slide-list" ng-show="wxapp == 'nav'">
									<div class="slide-heading">
										导航图标
									</div>
									<ul>
										{loop $navs $nav}
										<li>
											<div class="wxapp-slide-detail media">
												<div class="media-left media-middle slide-sort">
													{$nav['displayorder']}
												</div>
												<div class="media-left media-middle slide-img">
													<image src="{php echo tomedia($nav['icon'])}"></image>
												</div>
												<div class="media-body">
													<div class="slide-title">
														{$nav['name']}
													</div>
													<div class="slide-alter">
														<a href="" class="color-default" ng-click="navedit({$nav['id']})">编辑</a>
														<a href="{php echo url('wxapp/manage/edit', array('type' => 'nav', 'id' => $nav['id'], 'operate' => 'delete', 'multiid' => $multiid))}" onclick="return confirm('确认删除导航吗？');" class="color-default slide-del">删除</a>
													</div>
												</div>
											</div>
										</li>
										{/loop}
										<li class="slide-list-more">
											<a href="" class="slide-add" ng-click="navedit('add')">+</a>
										</li>
									</ul>
								</div>
								<div class="wxapp-slide-list" ng-show="wxapp == 'recommend'">
									<div class="slide-heading">
										推荐
									</div>
									<ul>
										{loop $recommends $recommend}
										<li>
											<div class="wxapp-slide-detail media">
												<div class="media-left media-middle slide-sort">
													{$recommend['displayorder']}
												</div>
												<div class="media-left media-middle slide-img">
													<img src="{php echo tomedia($recommend['thumb'])}"/>
												</div>
												<div class="media-body">
													<div class="slide-title">
														{$recommend['title']}
													</div>
													<div class="slide-alter">
														<a href="" class="color-default" ng-click="recommendedit({$recommend['id']}, '{$recommend['pcate']}')">编辑</a>
														<a href="{php echo url('wxapp/manage/edit', array('operate' => 'delete', 'type' => 'article', 'id' => $recommend['id'], 'multiid' => $multiid))}" onclick="return confirm('确认删除推荐吗？')" class="color-default slide-del">删除</a>
													</div>
												</div>
											</div>
										</li>
										{/loop}
										<li class="slide-list-more">
											<a href="javascript:void(0)" class="slide-add" ng-click="recommendedit('add')">+</a>
										</li>
									</ul>
								</div>
								<div class="wxapp-slide-edit" ng-show="wxapp == 'slideedit'">
									<div class="edit-heading">
										<a href="" class="go-back">
											<i class="fa fa fa-chevron-circle-left"></i>
										</a>
										<span class="color-gray">幻灯片列表 / </span>
										<span class="color-dark">新建幻灯片</span>
									</div>
									<form action="{php echo url('wxapp/manage/edit')}" method="post" class="form-defalut" enctype="multipart/form-data">
										<div class="form-defalut" ng-if="slideid == 'add'">
											<div class="form-group" >
												<label for="" class="control-label">标题</label>
												<div class="form_controls">
													<input type="text" required name="slide[title]" class="form-control input-slide-title"  placeholder="">
												</div>
											</div>
											<div class="form-group">
												<label for="" class="control-label">排序</label>
												<div class="form_controls">
													<input type="text" name="slide[displayorder]" class="form-control input-slide-sort" id="" placeholder="">
												</div>
											</div>
											<div class="form-group">
												<label for="" class="control-label">图片</label>
												<div class="form_controls">
													<div class="input-more" ng-class="imageclass" onclick="selectimage($(this))">
														<img src=""/>
														<div class="cover-dark">
															<a href="" class="cut">更换</a>
														</div>
													</div>
													<input type="text" name="slide[thumb]" style="display: none" value="">
												</div>
											</div>
											<div class="form-group">
												<label for="" class="control-label">链接</label>
												<div class="form_controls">
													<input type="url" name="slide[url]" class="form-control input-slide-link" required placeholder="">
												</div>
											</div>
											<input type="submit" name="submit" value="添加" class="btn btn-primary" />
											<input type="hidden" name="token" value="{$_W['token']}" />
											<input type="hidden" name="multiid" value="{$multiid}" />
										</div>
										{loop $slides $slide}
										<div class="form-defalut" ng-if="slideid == {$slide['id']}">
											<div class="form-group" >
												<label for="" class="control-label">标题</label>
												<div class="form_controls">
													<input type="text" name="slide[title]" class="form-control input-slide-title" required value="{$slide['title']}" placeholder="">
												</div>
											</div>
											<div class="form-group">
												<label for="" class="control-label">排序</label>
												<div class="form_controls">
													<input type="text" name="slide[displayorder]" class="form-control input-slide-sort" id="" value="{$slide['displayorder']}" placeholder="">
												</div>
											</div>
											<div class="form-group">
												<label for="" class="control-label">图片</label>
												<div class="form_controls">
													<div class="input-more active" onclick="selectimage($(this))">
														<img src="{php echo tomedia($slide['thumb'])}"/>
														<div class="cover-dark">
															<a href="" class="cut">更换</a>
														</div>
													</div>
													<input type="text" name="slide[thumb]" style="display: none;" value="{$slide['thumb']}">
												</div>
											</div>
											<div class="form-group">
												<label for="" class="control-label">链接</label>
												<div class="form_controls">
													<input type="url" name="slide[url]" class="form-control input-slide-link" required value="{$slide['url']}" id="" placeholder="">
												</div>
											</div>
											<input type="submit" name="submit" value="提交" class="btn btn-primary" />
											<input type="hidden" name="token" value="{$_W['token']}">
											<input type="hidden" name="id" value="{$slide['id']}">
											<input type="hidden" name="multiid" value="{$multiid}" />
										</div>
										{/loop}
									</form>
								</div>
								<div class="wxapp-slide-edit" ng-show="wxapp == 'navedit'">
									<div class="edit-heading">
										<a href="" class="go-back">
											<i class="fa fa fa-chevron-circle-left"></i>
										</a>
										<span class="color-gray">导航列表 / </span>
										<span class="color-dark">新建导航图标</span>
									</div>
									<form action="{php echo url('wxapp/manage/edit')}" method="post" class="form-defalut" enctype="multipart/form-data">
										<div class="form-defalut" ng-if="navid == 'add'">
											<div class="form-group" >
												<label for="" class="control-label">标题</label>
												<div class="form_controls">
													<input type="text" name="nav[name]" required class="form-control input-slide-title"  placeholder="">
												</div>
											</div>
											<div class="form-group">
												<label for="" class="control-label">排序</label>
												<div class="form_controls">
													<input type="text" name="nav[displayorder]" class="form-control input-slide-sort" placeholder="">
												</div>
											</div>
											<div class="form-group">
												<label for="" class="control-label">图片</label>
												<div class="form_controls">
													<div class="input-more" onclick="selectimage($(this))">
														<img src=""/>
														<div class="cover-dark">
															<a href="" class="cut">更换</a>
														</div>
													</div>
													<input type="text" name="nav[icon]" style="display: none" value="">
												</div>
											</div>
											<div class="form-group">
												<label for="" class="control-label">链接</label>
												<div class="form_controls">
													<input type="url" name="nav[url]" required class="form-control input-slide-link" id="" placeholder="">
												</div>
											</div>
											<input type="submit" name="submit"  value="添加" class="btn btn-primary" />
											<input type="hidden" name="token" value="{$_W['token']}" />
											<input type="hidden" name="multiid" value="{$multiid}" />
										</div>
										{loop $navs $nav}
										<div class="form-defalut" ng-if="navid == {php echo $nav['id']}">
											<div class="form-group" >
												<label for="" class="control-label">标题</label>
												<div class="form_controls">
													<input type="text" name="nav[name]" required class="form-control input-slide-title" value="{$nav['name']}" placeholder="">
												</div>
											</div>
											<div class="form-group">
												<label for="" class="control-label">排序</label>
												<div class="form_controls">
													<input type="text" name="nav[displayorder]" class="form-control input-slide-sort" id="" value="{$nav['displayorder']}" placeholder="">
												</div>
											</div>
											<div class="form-group">
												<label for="" class="control-label">图片</label>
												<div class="form_controls">
													<div class="input-more active" onclick="selectimage($(this))">
														<img src="{php echo tomedia($nav['icon'])}"/>
														<div class="cover-dark">
															<a href="" class="cut">更换</a>
														</div>
													</div>
													<input type="text" name="nav[icon]" style="display: none"  value="{$nav['icon']}">
												</div>
											</div>
											<div class="form-group">
												<label for="" class="control-label">链接</label>
												<div class="form_controls">
													<input type="url" name="nav[url]" required class="form-control input-slide-link" value="{$nav['url']}" id="" placeholder="">
												</div>
											</div>
											<input type="submit" name="submit" id="" value="提交" class="btn btn-primary" />
											<input type="hidden" name="token" value="{$_W['token']}">
											<input type="hidden" name="id" value="{$nav['id']}">
											<input type="hidden" name="multiid" value="{$multiid}" />
										</div>
										{/loop}
									</form>
								</div>
								<div class="wxapp-slide-edit" ng-show="wxapp == 'recommendedit'">
									<div class="edit-heading">
										<a href="" class="go-back">
											<i class="fa fa fa-chevron-circle-left"></i>
										</a>
										<span class="color-gray">导航列表 / </span>
										<span class="color-dark">新建导航图标</span>
									</div>
									<form action="{php echo url('wxapp/manage/edit')}" method="post" class="form-defalut" enctype="multipart/form-data">
										<div class="form-defalut" ng-if="recommendid == 'add'">
											<div class="form-group" >
												<label for="" class="control-label">标题</label>
												<div class="form_controls">
													<input type="text" required name="recommend[title]" class="form-control input-slide-title"  placeholder="">
												</div>
											</div>
											<div class="form-group">
												<label for="" class="control-label">排序</label>
												<div class="form_controls">
													<input type="text" name="recommend[displayorder]" class="form-control input-slide-sort" id="" placeholder="">
												</div>
											</div>
											<div class="form-group form-inline">
												<label for="" class="control-label">分类</label>
												<div class="form_controls">
													<select class="form-control" name="recommend[ccate]">
														<option>选择分类</option>
														<option ng-repeat="category in categorys" value="{{ category.id }}">{{ category.name }}</option>
													</select>
												</div>
												<a class="btn" data-toggle="modal" data-target="#myModal" ng-click="get_categorys()">设置分类</a>
												<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
													<div class="modal-dialog">
														<div class="modal-content">
															<div class="modal-header">
																<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
																<h4 class="modal-title" id="myModalLabel">分类设置</h4>
															</div>
															<div class="modal-body">
																<table class="table">
																	<thead>
																		<th>类名</th>
																		<th>排序</th>
																		<th>链接</th>
																		<th>操作</th>
																	</thead>
																	<tbody>
																		<tr ng-repeat="category in categorys">
																			<td><input ng-model="category.name"></td>
																			<td><input ng-model="category['displayorder']"></td>
																			<td><input ng-model="category['linkurl']"></td>
																			<td><a href="" ng-click="del_category($index)">删除</a></td>
																		</tr>
																	</tbody>
																</table>
																<button type="button" class="btn btn-primary" ng-click="edit_category()">添加分类</button>
																<button type="button" class="btn btn-primary" ng-click="save_category()">保存</button>
															</div>
														</div>
													</div>
												</div>
											</div>
											<div class="form-group">
												<label for="" class="control-label">图片</label>
												<div class="form_controls">
													<div class="input-more"  onclick="selectimage($(this))">
														<img src=""/>
														<div class="cover-dark">
															<a href="" class="cut">更换</a>
														</div>
													</div>
													<input type="text" name="recommend[thumb]" style="display: none" vlaue="">
												</div>
											</div>
											<div class="form-group">
												<label for="" class="control-label">链接</label>
												<div class="form_controls">
													<input type="url" name="recommend[source]" required class="form-control input-slide-link" id="" placeholder="">
												</div>
											</div>
											<input type="submit" name="submit"  value="添加" class="btn btn-primary" />
											<input type="hidden" name="token" value="{$_W['token']}" />
											<input type="hidden" name="multiid" value="{$multiid}" />
										</div>
										{loop $recommends $recommend}
										<div class="form-defalut" ng-if="recommendid == {$recommend['id']}">
											<div class="form-group" >
												<label for="" class="control-label">标题</label>
												<div class="form_controls">
													<input type="text" name="recommend[title]"  required class="form-control input-slide-title" value="{$recommend['title']}" placeholder="">
												</div>
											</div>
											<div class="form-group">
												<label for="" class="control-label">排序</label>
												<div class="form_controls">
													<input type="text" name="recommend[displayorder]" class="form-control input-slide-sort" id="" value="{$recommend['displayorder']}" placeholder="">
												</div>
											</div>
											<div class="form-group form-inline">
												<label for="" class="control-label">分类</label>
												<div class="form_controls">
													<select class="form-control" name="recommend[ccate]">
														<option>选择分类</option>
														<option ng-repeat="category in categorys" value="{{ category.id }}" ng-selected="category.id == {$recommend['ccate']}">{{ category.name }}</option>
													</select>
													<a class="btn btn-default" data-toggle="modal" data-target="#myModal" ng-click="get_categorys()">设置分类</a>
												</div>
											</div>
											
											<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
												<div class="modal-dialog modal-dialog-default  modal-lg">
													<div class="modal-content">
														<div class="modal-header">
															<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
															<h4 class="modal-title" id="myModalLabel">分类设置</h4>
														</div>
														<div class="modal-body">
															<table class="table we7-table we7-form">
																<tr>
																<th>类名</th>
																<th>排序</th>
																<th>链接</th>
																<th>操作</th>
																</tr>
																<tbody>
																<tr ng-repeat="category in categorys">
																	<td><input ng-model="category.name" class="form-control" size="15"></td>
																	<td><input ng-model="category['displayorder']" class="form-control"></td>
																	<td><input ng-model="category['linkurl']" class="form-control"></td>
																	<td><a href="" ng-click="del_category($index)">删除</a></td>
																</tr>
																<tr>
																	<td colspan="4"><a href="javascript:;" class="buttom-add color-default" ng-click="edit_category()" style="text-decoration: none;">添加分类</a></td>
																	
																</tr>
																</tbody>
															</table>
															<!--<button type="button" class="btn btn-primary" ng-click="edit_category()">添加分类</button>-->
															<button type="button" class="btn btn-primary" ng-click="save_category()" style="margin-left: 0px;">保存</button>
														</div>
													</div>
												</div>
											</div>
											<div class="form-group">
												<label for="" class="control-label">图片</label>
												<div class="form_controls">
													<div class="input-more active" onclick="selectimage($(this))">
														<img src="{php echo tomedia($recommend['thumb'])}"/>
														<div class="cover-dark">
															<a href="" class="cut">更换</a>
														</div>
													</div>
													<input type="text" name="recommend[thumb]" style="display: none" value="{php echo tomedia($recommend['thumb'])}">
												</div>
											</div>
											<div class="form-group">
												<label for="" class="control-label">链接</label>
												<div class="form_controls">
													<input type="url" name="recommend[source]" required class="form-control input-slide-link" value="{$recommend['source']}" id="" placeholder="">
												</div>
											</div>
											<input type="submit" name="submit" value="提交" class="btn btn-primary" />
											<input type="hidden" name="token" value="{$_W['token']}">
											<input type="hidden" name="id" value="{$recommend['id']}">
											<input type="hidden" name="multiid" value="{$multiid}" />
										</div>
										{/loop}
									</form>
								</div>
								<!--end列表-->
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<script>
	require(['angular', 'bootstrap', 'fileUploader'], function(){
		angular.module('editWxApp', []);
		angular.module('editWxApp').controller('MainCtrl', ['$scope', '$http', function($scope, $http){
			$scope.category = {
				'id' : '',
				'name' : '',
				'displayorder' : '',
				'linkurl' : ''
			};
			selectimage = function(element) {
				fileUploader.show(function(img) {
					element.find('img').first().attr('src', img.url);
					element.next('input').val(img.url);
					element.attr('class', 'input-more active');
				}, {'direct' : true, 'multiple' : false});
			};
			$scope.del_category = function(index) {
				if ($scope.categorys[index].id != undefined) {
					$http.post('{php echo url('wxapp/manage/del_category')}', {'id' : $scope.categorys[index].id}).success(function() {});
					$scope.get_categorys();
				} else {
					$scope.categorys.splice(index, 1);
				}
			}
			$scope.edit_category = function (category) {
				$scope.categorys.push({'name' : '', 'displayorder' : '', 'linkurl' : ''});
			};
			$scope.get_categorys = function() {
				$http.post('{php echo url('wxapp/manage/get_categorys')}', {'multiid' : '{$multiid}'}).success(function(data) {
					$scope.categorys = data.message.message;
				});
			};
			$scope.get_categorys();
			$scope.save_category = function() {
				$scope.name_exist = false;
				angular.forEach($scope.categorys, function(val) {
					if (val.name == '') {
						util.message('请填写类名');
						$scope.name_exist = true;
					}
				});
				if ($scope.name_exist == true) {
					return false;
				}
				$http.post('{php echo url('wxapp/manage/save_category')}', {'post' : $scope.categorys, 'multiid' : {$multiid}}).success(function() {});
				$scope.get_categorys();
				$('#myModal').modal('hide');
			};
			$scope.wxapp = '{$_GPC['wxapp']}' == '' ? 'slide' : '{$_GPC['wxapp']}';
			$scope.slideedit = function (id) {
				$scope.wxapp = 'slideedit';
				$scope.slideid = id;
			};
			$scope.navedit = function (id) {
				$scope.wxapp = 'navedit';
				$scope.navid = id;
			};
			$scope.recommendedit = function (id,pid) {
				$scope.wxapp = 'recommendedit';
				$scope.recommendid = id;
				$scope.recommendpid = pid;
			};
		}]);
		angular.bootstrap(document, ['editWxApp']);
	});
</script>
</body>
</html>