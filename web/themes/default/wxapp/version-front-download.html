{template 'common/header'}
<!--小程序前端下载-->

    <ul class="we7-page-tab">
        <li class="active"><a href="#">小程序审核发布</a></li>
        <li><a href="#">小程序域名设置</a></li>
    </ul>
    <div class="we7-flex wxapp-examine-tab">
        <div>
            <a  {if $uptype == ''} active {/if}
                    href="{php echo url('wxapp/front-download/front_download', array('uptype'=>'','version_id'=>$version_id))}">
                <div class="arrow-up"></div>
                <span class="wi wi-wxapp-webpack"></span>在微信小程序后台提交审核
            </a>
        </div>
        <div>
            <a {if $uptype == 'auto'} active {/if}
                    href="{php echo url('wxapp/front-download/front_download', array('uptype'=>'auto','version_id'=>$version_id))}" class="active">
                <div class="arrow-up"></div>
                <span class="wi wi-wxapp-upload"></span>小程序可自行提交审核
            </a>
        </div>
    </div>
    {if $uptype == ''}
    <!--在微信小程序后台提交审核-->
    <div class="media media-wechat-setting">
        <div class="media-left color-default">
            <span class="wi wi-wxapp-webpack" style="font-size: 55px;"></span>
        </div>
        <div class="media-body media-middle ">
            <h4 class="media-heading color-dark">{$wxapp_versions_info['modules'][0]['title']}</h4>
            <div class="color-gray">版本: v{$wxapp_versions_info['version']}</div>
        </div>
        <div class="media-right media-middle">
            <a href="./index.php?c=wxapp&a=manage&do=getpackage&uniacid={$_W['uniacid']}&versionid={$wxapp_versions_info['id']}" class="btn btn-primary">立即下载</a>
        </div>
    </div>
<div class="panel we7-panel">
    <div class="panel-heading">设置小程序域名</div>
    <div class="panel-body we7-padding">
        <form action="./index.php?c=wxapp&a=manage&do=getpackage&uniacid={$_W['uniacid']}&versionid={$wxapp_versions_info['id']}" class="we7-form" method="get">
            <div class="form-group">
                <label class="control-label col-sm-2">设置小程序URL</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" name="appurl" value="{$appurl}" placeholder="默认URL: ">
                </div>
            </div>
            <div class="form-group">
                <label class="control-label col-sm-2"></label>
                <div class="col-sm-10">
                    <button class="btn btn-primary" type="submit" >下载</button>
                </div>
            </div>
        </form>
    </div>
</div>
<div class="wxapp-download-procedure">
    <div class="title color-gray">设置小程序域名说明：</div>
    <div class="step">1.设置链接域名，可以在微擎后台设置操作小程序。设置完成后到小程序审核发布里点击下载后，域名更新。</div>
    <div class="step">2.设置后的生效页面（<a href="#" class="color-default">站点管理</a><span class="color-default"><i class="wi wi-angle-right"></i></span> <a href="#" class="color-default">站点设置</a>）</div>
    <div class="img">
        <img src="../../../pros/web/resource/images/wxapp/12.png" alt="" class="img-responsive">
    </div>
</div>
    <div class="wxapp-download-procedure">
    <div class="title color-gray">小程序前端下载后操作流程说明：</div>
    <div class="step">1.进入微信小程序后台（mp.weixin.qq.com），添加小程序开发者（如已经是管理员或开发者则不需要添加）</div>
    <div class="img">
        <img src="./resource/images/wxapp/01.png" alt="" />
        <img src="./resource/images/wxapp/02.png" alt="" />
    </div>
    <div class="step">2.进入小程序后台，点击设置，开发设置，修改服务器域名（设置自己的微擎域名，<span class="color-default">必须是https://</span>）</div>
    <div class="img">
        <img src="./resource/images/wxapp/03.png" alt="" />
        <img src="./resource/images/wxapp/04.png" alt="" />
    </div>
    <div class="step">3.下载 微信web开发者工具（本帖会附上工具下载地址），更新到最新版后（切记），点击，填写小程序appid。将之前<span class="color-default">下载解压后的小程序插件上传</span></div>
    <div class="img">
        <img src="./resource/images/wxapp/05.png" alt="" />
        <img src="./resource/images/wxapp/06.png" alt="" />
        <img src="./resource/images/wxapp/07.png" alt="" />
    </div>
    <div class="step">4.点击项目，上传，并设置版本号和项目名称（项目名称自定义）</div>
    <div class="img">
        <img src="./resource/images/wxapp/08.png" alt="" />
        <img src="./resource/images/wxapp/09.png" alt="" />
    </div>
    <div class="step">5.进入小程序后台（mp.weixin.qq.com），点击开发管理，提交审核，小程序<span class="color-default">管理员</span>（必须需要管理员扫描，小程序开发者不可）扫描即可</div>
    <div class="img">
        <img src="./resource/images/wxapp/10.png" alt="" />
        <img src="./resource/images/wxapp/11.png" alt="" />
    </div>
    <div class="step">6.微信官方审核通过即可使用</div>
</div>
    {/if}
    <!--end 在微信小程序后台提交审核-->

    <!--小程序可自行提交审核-->
    {if $uptype=='auto'}
    <div class="panel we7-panel wxapp-examine-self" >
        <div class="panel-heading">上传小程序代码</div>
        <div class="panel-body">
            <div class="step">第<span class="num">1</span>步</div>
            <div class="text-center">
                <img src="" alt="" class="qr-img" id="qrcode">
                <div>请先扫描以上二维码，成功后再填写版本信息</div>
            </div>
        </div>
        <div class="panel-footer bg-light-gray">
            <div class="step">第<span class="num">2</span>步</div>
            <form action="" class="we7-form">
                <div class="form-group">
                    <label class="control-label col-sm-2">AppID</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="appid" name="appid">
                        <span class="help-block">
													请填写小程序的AppID
												</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="control-label col-sm-2">设置小程序URL</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" value="{$appurl}" id="appurl">
                    </div>
                </div>

                <div class="form-group">
                    <label class="control-label col-sm-2">版本号</label>
                    <div class="col-sm-10">
                        <input type="number" class="form-control" id="user_version" name="user_version">
                        <span class="help-block">
													版本号仅限字母、数字
												</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label col-sm-2">版本描述</label>
                    <div class="col-sm-10">
                        <textarea rows="3" class="form-control" id="user_desc" name="user_desc"></textarea>
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label col-sm-2"></label>
                    <div class="col-sm-10">
                        <input type="hidden" name="ticket" id="ticket">
                        <button class="btn btn-primary" type="button" id="commitcode" disabled>保存并上传代码</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {/if}
    <!--end 小程序可自行提交审核-->

    {if $do == 'set_domain'}
    <!--小程序域名设置-->
    <div class="panel we7-panel">
        <div class="panel-heading">设置小程序域名</div>
        <div class="panel-body we7-padding">
            <form action="" class="we7-form">
                <div class="form-group">
                    <label class="control-label col-sm-2">设置小程序URL</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" placeholder="默认URL: ">
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label col-sm-2"></label>
                    <div class="col-sm-10">
                        <button class="btn btn-primary" type="button" >下载</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="wxapp-download-procedure">
        <div class="title color-gray">设置小程序域名说明：</div>
        <div class="step">1.设置链接域名，可以在微擎后台设置操作小程序。设置完成后到小程序审核发布里点击下载后，域名更新。</div>
        <div class="step">2.设置后的生效页面（<a href="#" class="color-default">站点管理</a><span class="color-default"><i class="wi wi-angle-right"></i></span> <a href="#" class="color-default">站点设置</a>）</div>
        <div class="img">
            <img src="../../../pros/web/resource/images/wxapp/12.png" alt="" class="img-responsive">
        </div>
    </div>
    {/if}
    <!--end 小程序域名设置-->
    {if $uptype == 'auto'}
        <script type="text/javascript">
	        $(function(){
		        var UUIDURL = "{php echo url('wxapp/front-download/uuid')}";
		        var QRCODEURL = "{php echo url('wxapp/front-download/qrcode')}";
		        var CHECKSANURL = "{php echo url('wxapp/front-download/checkscan')}";
		        var COMMITURL = "{php echo url('wxapp/front-download/commitcode')}";
		        var uuid = null;
		        function ajax(url, data) {
			        var def = $.Deferred();
			        $.ajax({
				        'url':url,
				        'timeout':30000,
				        'data' : data,
				        'dataType':'json',
				        'success':function(data){
					        def.resolve(data);
				        },
				        'error': function (error) {
					        def.reject();
				        }
			        });
			        return def;
		        }
		        // 获取UUID
		        var getUuid = function() {
			        return ajax(UUIDURL);
		        }
		        // 显示二维码
		        function qrcode() {
			        return getUuid().then(function(data){
				        var def = $.Deferred();
				        if(data.errno == 1) {
					        window.location.reload();
				        }
				        uuid = data.data.uuid;
				        $('#qrcode').attr('src', QRCODEURL+'&uuid='+uuid);
				        def.resolve(uuid);
				        return def;
			        })
		        }

		        //
		        /**
		         * 408 超时
		         * 404 已扫码
		         * 403 已取消
		         * 405 正常扫码  可以获取code
		         * 402 500 都是错误
		         *  扫码结果确认
		         */
		        // 获取扫码结果
		        function checkscan(uuid, last) {
			        if(!last) {
				        last = 408;
			        }
			        var url = CHECKSANURL+'&uuid='+uuid+'&last='+last;
			        return ajax(url).then(function(data){
				        if(data.errno == 1) {
				        	checkscan(uuid, last);
				        	return;
                        }
				        if(data.errno == 0) {
					        var errcode = parseInt(data.data.errcode);
					        switch (errcode) {
						        case 408 : console.log('超时'); break;
						        case 404 : console.log('已扫码'); break;
						        case 403 : console.log('已取消'); break;
                                case 405 :
							        $('#codeform').show();
							        $('#commitcode').removeAttr('disabled');
							        $('#ticket').val(data.data.ticket);
							        console.log('授权成功');
							        console.log('ticket:'+ data.data.ticket);
							        break;
					        }
					        if(errcode != 405) {
						        return checkscan(uuid, errcode);
					        }
				        }
			        },function(error){
				        //可能超时的处理
				        console.log('timeout');
				        return checkscan(uuid,last);
			        });
		        }

		        // 启动
		        function start() {
			        qrcode().then(function (uuid) {
				        return checkscan(uuid);
			        });
			        $('#commit').click(function(){
				        var ticket = $.trim($('#ticket').val());
				        var appid = $('#appid').val();
				        var appurl = $.trim($('#appurl').val());
				        if($.trim(appid)== '' || $.trim(appurl))
				        if($.trim(ticket)) {
				        	alert('请先扫码');
				        	return;
                        }
				        var user_version = $('#user_version').val();
				        var user_desc = $('#user_desc').val();
				        var url = COMMITURL+'ticket='+ticket+'&appid='+appid+'&user_version='+user_version+'&user_desc='+user_desc;
				        ajax(url).then(function(data){
					        if(data.errno == '0') {
						        alert('提交成功');
						        return;
					        }
					        alert(data.message);
				        })
			        })
		        }
//		        start();
	        });
        </script>
    {/if}

{template 'common/footer'}