{template 'common/header'}
<p>自动回复</p>
<ul class="nav nav-tabs">
	<li {if $m == 'keyword' || $m == ''}class="active"{/if}><a href="{url 'platform/autoreply' array('m' => 'keyword')}">关键字自动回复</a></li>
	<li {if $m == 'special'}class="active"{/if}><a href="{url 'platform/autoreply' array('m' => 'special')}">非文字自动回复</a></li>
	<li {if $m == 'system'}class="active"{/if}><a href="{url 'platform/autoreply' array('m' => 'system')}">首次访问自动回复</a></li>
</ul>
{if $m == 'keyword'}
<div class="clearfix">
	<div class="panel panel-info">
		<div class="panel-heading">筛选</div>
		<div class="panel-body">
			<form action="./index.php" method="get" class="form-horizontal" role="form">
			<input type="hidden" name="c" value="platform">
			<input type="hidden" name="a" value="reply">
			<input type="hidden" name="m" value="{$_GPC['m']}" />
			<input type="hidden" name="status" value="{$status}" />
				<div class="form-group">
					<label class="col-xs-12 col-sm-2 col-md-2 col-lg-1 control-label">状态</label>
					<div class="col-sm-8 col-lg-9 col-xs-12">
						<div class="btn-group">
							<a href="{php echo filter_url('status:-1');}"  class="btn {if $_GPC['status'] == '-1'|| $_GPC['status'] == ''}btn-primary{else}btn-default{/if}">所有</a>
							<a href="{php echo filter_url('status:1');}"  class="btn {if $_GPC['status']== '1'}btn-primary{else}btn-default{/if}">启用</a>
							<a href="{php echo filter_url('status:0');}"  class="btn {if $_GPC['status'] == '0'}btn-primary{else}btn-default{/if}">禁用</a>
						</div>
					</div>
				</div>
				<div class="form-group">
					<label class="col-xs-12 col-sm-2 col-md-2 col-lg-1 control-label">规则名称</label>
					<div class="col-sm-8 col-xs-12">
							<input class="form-control" name="keyword" id="" type="text" value="{$_GPC['keyword']}">
					</div>
					<div class="col-xs-12 col-sm-2 col-lg-1 text-right">
						<button class="btn btn-default"><i class="fa fa-search"></i> 搜索</button>
					</div>
				</div>
			</form>
		</div>
		<div style="float:right;height:20px;margin-top:-25px;margin-right:130px"><a href="{url 'platform/autoreply' array('do' => 'post', 'm' => $m)}"><i class="fa fa-plus"></i>添加关键词回复</a></div>
		<div style="float:right;height:20px;margin-top:-25px;margin-right:10px"><a href="{url 'platform/autoreply' array('do' => 'post', 'm' => 'apply')}"><i class="fa fa-plus"></i>添加应用关键字</a></div>
	</div>
	<form action="{php echo url('platform/reply/delete');}" method="post" class="form-horizontal" role="form" id="form1">
	<input type="hidden" name="m" value="{$m}"/>
	<ul style="height:40px;list-style-type:none">
		<li style="float:left;margin-left:10px" class="btn btn-default">全部</li>
		<li style="float:left;margin-left:10px" class="btn btn-default">回复图文</li>
		<li style="float:left;margin-left:10px" class="btn btn-default">回复模块</li>
		<li style="float:left;margin-left:10px" class="btn btn-default">回复语音</li>
		<li style="float:left;margin-left:10px" class="btn btn-default">回复文字</li>
		<li style="float:left;margin-left:10px" class="btn btn-default">回复音乐</li>
		<li style="float:left;margin-left:10px" class="btn btn-default">回复图片</li>
	</ul>
	{if !empty($replies)}
	<div>
		{loop $replies $row}
		<div class="panel panel-default">
			<div class="panel-heading clearfix">
				<label class="checkbox-inline" style="padding-top:0">规则名： {$row['name']}</label>
				<span class="pull-right">
					{if $row['displayorder'] > 0}
						{if $row['displayorder'] == '255'}
							<span class="label label-primary">置顶</span>
						{else}
							<span class="label label-info">优先级 {$row['displayorder']}</span>
						{/if}
					{/if}
					{if $row['status'] == '0'}<span class="label label-danger">已禁用</span>{/if}
				</span>
			</div>
			<div class="panel-body">
				关键词：
				{loop $row['keywords'] $kw}
				<span class="label label-default" data-toggle="tooltip" data-placement="top" title="{if $kw['type']==1}等于{elseif $kw['type']==2}包含{elseif $kw['type']==3}正则{/if}">{$kw['content']}</span>&nbsp;
				{if $kw['type'] == 4}<span class="label label-info" data-toggle="tooltip" data-placement="top" title="托管">优先级在{$row['displayorder']}之下直接生效</span>{/if}
				{/loop}
			</div>
			<div class="panel-body">
				回复内容：
				{loop $row['keywords'] $kw}
				<span class="label label-default" data-toggle="tooltip" data-placement="top" title="{if $kw['type']==1}等于{elseif $kw['type']==2}包含{elseif $kw['type']==3}正则{/if}">{$kw['content']}</span>&nbsp;
				{if $kw['type'] == 4}<span class="label label-info" data-toggle="tooltip" data-placement="top" title="托管">优先级在{$row['displayorder']}之下直接生效</span>{/if}
				{/loop}
			</div>
			<div class="panel-footer clearfix">
				<div class="btn-group pull-right">
					<a class="btn btn-default btn-sm" href="javascript:;">是否开启：<input type="checkbox" name="" class="btn btn-sm"></a>
					<a class="btn btn-default btn-sm" href="{php echo url('platform/autoreply/post', array('m' => $m, 'rid' => $row['id']))}"><i class="fa fa-edit"></i> 编辑</a>
					<a class="btn btn-default btn-sm" href="{php echo url('platform/autoreply/delete', array('m' => $m, 'rid' => $row['id']))}" onclick="return confirm('删除规则将同时删除关键字与回复，确认吗？');return false;"><i class="fa fa-times"></i> 删除</a>
					<a class="btn btn-default btn-sm" href="{php echo url('platform/stat/trend', array('id' => $row['id'], 'm' => $row['module']))}"><i class="fa fa-bar-chart-o"></i> 使用率走势</a>
					{if $row['options']}
					<div class="btn-group">
						<button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown">
							功能选项
							<span class="caret"></span>
						</button>
						<ul class="dropdown-menu" style="min-width:0px;">
							{loop $row['options'] $opt}
								<li><a href="{$opt['url']}">{$opt['title']}</a></li>
							{/loop}
						</ul>
					</div>
					{/if}
				</div>
			</div>
		</div>
		{/loop}
	</div>
	<div>
		<label class="checkbox-inline" style="margin-top:-30px;margin-left:17px"><input type="checkbox" name="select_all" id="select_all" value="1"/></label>
		<input type="submit" class="btn btn-danger" value="删除" onclick="if(!confirm('确定删除选中的规则吗？')) return false;"/>
		<input type="hidden" name="token" value="{$_W['token']}"/>
	</div>
	{/if}
	</form>
	{$pager}
</div>
<script>
require(['bootstrap'], function($){
	$(function () {
		$('[data-toggle="tooltip"]').tooltip();
		$('#select_all').click(function(){
			$('#form1 :checkbox').prop('checked', $(this).prop('checked'));
		});
		$('#form1 :checkbox').click(function(){
			if(!$(this).prop('checked')) {
				$('#select_all').prop('checked', false);
			} else {
				var flag = 0;
				$('#form1 :checkbox[name="rid[]"]').each(function(){
					if(!$(this).prop('checked') && !flag) {
						flag = 1;
					}
				});
				if(flag) {
					$('#select_all').prop('checked', false);
				} else {
					$('#select_all').prop('checked', true);
				}
			}
		});
	})
});
</script>
{elseif $m == 'special'}
<div class="clearfix">
	<form action="?{$_SERVER['QUERY_STRING']}" method="post">
		<div class="panel panel-default">
			<div class="panel-body table-responsive">
				<table class="table table-hover"  style="width:100%;z-index:-10;" cellspacing="0" cellpadding="0">
					<thead class="navbar-inner">
					<tr>
						<th style="">类型</th>
						<th style="">关键字</th>
						<th style="width:410px;">状态</th>
						<th style="min-width:70px;">操作</th>
					</tr>
					</thead>
					<tbody>
					{loop $mtypes $name $title}
					<tr>
						<td>{$title}</td>
						<td>{$setting[$name]['keyword']}</td>
						<td>{if !empty($setting[$name]['type'])}开启{else}关闭{/if}</td>
						<td><a href="{php echo url('platform/autoreply/post', array('m' => 'special', 'type' => $name))}">编辑</a></td>
					</tr>
					{/loop}
					</tbody>
				</table>
			</div>
		</div>
	</form>
</div>
{elseif $m == 'system'}
<form class="form form-horizontal" action="" method="post">
	<input type="hidden" name="id" value="{$rule['rule'][id]}">
	<div class="panel panel-default">
		<div class="panel-heading">
			系统回复
		</div>
		<div class="panel-body">
			<div class="form-group">
				<label class="col-xs-12 col-sm-3 col-md-2 control-label">欢迎信息关键字:</label>
				<div class="col-sm-9 col-xs-12" style="position:relative">
					<div class="input-group">
						<input type="text" name="welcome" class="form-control" id="welcomeinput" value="{$setting['welcome']}" placeholder="可根据关键字直接关联指定的回复规则" autocomplete="off" />
						<div class="input-group-btn">
							<span class="btn btn-primary" id="welcome_search"><i class="fa fa-search"></i> 搜索</span>
						</div>
					</div>
					<div id="welcome_menu" style="width:100%;position:absolute;top:32px;left:16px;display:none;z-index:10000">
						<ul class="dropdown-menu" style="display:block;width:91%;height:400px;overflow-y:scroll;"></ul>
					</div>
					<div class="help-block">设置用户添加公众帐号好友时，发送的欢迎信息。<a href="javascript:;" id="welcome"><i class="fa fa-github-alt"></i> 表情</a></div>
					<div class="help-block">
						指定用户添加公众帐号好友时，发送的欢迎信息, 你可以在这里输入关键字, 那么用户添加公众号好友时就相当于发送这个内容至微擎系统<br>
						这个过程是程序模拟的, 比如这里添加关键字: 欢迎关注, 那么用户添加公众号好友时, 微擎系统相当于接受了粉丝用户的消息, 内容为"欢迎关注"
					</div>
				</div>
			</div>
			<div class="form-group">
				<label class="col-xs-12 col-sm-3 col-md-2 control-label">默认回复关键字:</label>
				<div class="col-sm-9 col-xs-12">
					<div class="input-group">
						<input type="text" name="default" class="form-control" id="defaultinput" value="{$setting['default']}" placeholder="可根据关键字直接关联指定的回复规则" />
						<div class="input-group-btn">
							<span class="btn btn-primary search" id="default_search"><i class="fa fa-search"></i> 搜索</span>
						</div>
					</div>
					<div id="default_menu" style="width:100%;position:absolute;top:32px;left:16px;display:none;z-index:10000">
						<ul class="dropdown-menu" style="display:block;width:91%;height:400px;overflow-y:scroll"></ul>
					</div>
					<div class="help-block">当系统不知道该如何回复粉丝的消息时，默认发送的内容。<a href="javascript:;" id="default"><i class="fa fa-github-alt"></i> 表情</a></div>
					<div class="help-block">
						指定系统不知道该如何回复粉丝的消息时，发送的默认信息, 你可以在这里输入关键字, 那么系统不知道该如何回复粉丝的消息时就相当于发送这个内容至微擎系统<br>
						这个过程是程序模拟的, 比如这里添加关键字: ￥@%&%#@*, 系统不知道该如何回复粉丝的消息, 微擎系统相当于接受了粉丝用户的消息, 内容为"￥@%&%#@*"
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="form-group">
		<div class="col-sm-12">
			<input name="submit" type="submit" value="提交" class="btn btn-primary col-lg-1" />
			<input type="hidden" name="token" value="{$_W['token']}" />
		</div>
	</div>
</form>
</div>
<script>
	util.emotion($("#default"), $("#defaultinput")[0]);
	util.emotion($("#welcome"), $("#welcomeinput")[0]);
	function select_keyword(clickid, menuid, inputid){
		$(clickid).click(function(){
			var search_value = $(inputid).val();
			$('body').append('<div class="layer_bg"></div>');
			$('.layer_bg').height($(document).height());
			$('.layer_bg').css({width : '100%', position : 'absolute', top : '0', left : '0', 'z-index' : '0'});
			$.post("{php echo url('platform/special/search_key')}", {'key_word' : search_value}, function(data){
				var data = $.parseJSON(data);
				var total = data.length;
				var html = '';
				if(total > 0) {
					for(var i = 0; i < total; i++) {
						html += '<li><a href="javascript:;">' + data[i] + '</a></li>';
					}
				} else {
					html += '<li><a href="javascript:;" class="no-result">没有匹配到您输入的关键字</a></li>';
				}
				$(menuid + ' ul').html(html);
				$(menuid + ' ul li a[class!="no-result"]').click(function(){
					$('.layer_bg').remove();
					$(inputid).val($(this).html());
					$(menuid).hide();
				});
				$(menuid).show();
			});
			$('.layer_bg').click(function(){
				$(menuid).hide();
				$(this).remove();
			});

		});
		$(inputid).keydown(function(event){
			if(event.keyCode == 13){
				$(clickid).click();
				return false;
			}
		});
	}
	select_keyword('#welcome_search', '#welcome_menu', '#welcomeinput');
	select_keyword('#default_search', '#default_menu', '#defaultinput');
</script>
{/if}
{template 'common/footer'}
