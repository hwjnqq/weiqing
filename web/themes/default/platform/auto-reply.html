{template 'common/header'}
	<div class="keyword-list">
		<div class="we7-page-title">
			自动回复
		</div>
		<ul class="we7-page-tab">
			<li {if $m == 'keyword' || $m == ''}class="active" {/if}><a href="{url 'platform/autoreply' array('m' => 'keyword')}">关键字自动回复 </a></li>
			<li {if $m == 'special'}class="active"{/if}><a href="{url 'platform/autoreply' array('m' => 'special')}">非文字自动回复</a></li>
			<li {if $m == 'system'}class="active"{/if}><a href="{url 'platform/autoreply' array('m' => 'system')}">首次访问自动回复</a></li>
		</ul>

		{if $m == 'keyword'}
		<div ng-controller="KeywordDisplay" ng-cloak>
			<div class="keyword-list-head">
				<form action="./index.php" method="get" class="form-horizontal" role="form">
					<input type="hidden" name="c" value="platform">
					<input type="hidden" name="a" value="autoreply">
					<input type="hidden" name="m" value="{$_GPC['m']}" />
					<input type="hidden" name="status" value="{$status}" />
					<div class="keyword-list-head">
						<div class="input-group pull-left" style="width: 400px;">
							<input class="form-control" name="keyword" type="text" value="{$_GPC['keyword']}">
							<button class="btn btn-default"><i class="fa fa-search"></i></button>
						</div>
						<div class="pull-right">
							<a href="{url 'platform/autoreply/post' array('m' => $m)}" class="btn btn-primary">+添加关键字回复</a>
							<a href="{url 'platform/autoreply/post' array('m' => 'apply')}" class="btn btn-danger">+添加应用关键字</a>
						</div>
					</div> 
				</form>
			</div>		
			<div class="btn-group we7-btn-group we7-padding-vertical">
				<a href="{url 'platform/autoreply/display' array('m' => 'keyword')}" class="btn {if !$_GPC[type]}active{/if}">全部</a>
				<a href="{url 'platform/autoreply/display' array('m' => 'keyword', 'type' => 'news')}" class="btn {if $_GPC[type] == 'news'}active{/if}">回复图文</a>
				<a href="{url 'platform/autoreply/display' array('m' => 'keyword', 'type' => 'apply')}" class="btn {if $_GPC[type] == 'apply'}active{/if}">回复模块</a>
				<a href="{url 'platform/autoreply/display' array('m' => 'keyword', 'type' => 'voice')}" class="btn {if $_GPC[type] == 'voice'}active{/if}">回复语音</a>
				<a href="{url 'platform/autoreply/display' array('m' => 'keyword', 'type' => 'basic')}" class="btn {if $_GPC[type] == 'basic'}active{/if}">回复文字</a>
				<a href="{url 'platform/autoreply/display' array('m' => 'keyword', 'type' => 'music')}" class="btn {if $_GPC[type] == 'music'}active{/if}">回复音乐</a>
				<a href="{url 'platform/autoreply/display' array('m' => 'keyword', 'type' => 'images')}" class="btn {if $_GPC[type] == 'images'}active{/if}">回复图片</a>
				<a href="{url 'platform/autoreply/display' array('m' => 'keyword', 'type' => 'video')}" class="btn {if $_GPC[type] == 'video'}active{/if}">回复视频</a>
			</div>
			<div class="we7-tables">
				<form action="{php echo url('platform/reply/delete');}" method="post" role="form" id="form1">
					<input type="hidden" name="m" value="{$m}"/>
					<!-- 应用关键字待补充 -->
					{if !empty($replies)}
						{loop $replies $row}
						<table class="we7-table">
							<col />
							<col width="120px"/>
							<col width="150px"/>
							<tr>
								<th class="text-left"><input type="checkbox" name="rid[]" value="{$row['id']}"/> 规则名：{$row['name']}
									<span class="pull-right">
										{if $row['displayorder'] > 0}
											{if $row['displayorder'] == '255'}
												<span class="label label-primary">置顶</span>
											{else}
												<span class="label label-info">优先级 {$row['displayorder']}</span>
											{/if}
										{/if}
										{if $row['status'] == '0'}<span class="label label-danger">已禁用</span>{/if}
									</span>
								</th>
								<th>是否开启</th>
								<th class="text-left">操作</th>
							</tr>
							<tr>
								<td class="text-left">
									<div class="we7-form">
										<div class="form-inline">
											<label for="" class="control-label">关&nbsp;键&nbsp;字</label>
											<div class="form-controls">
												{loop $row['keywords'] $kw}
												<p class="form-control-static keyword-tag" data-toggle="tooltip" data-placement="top" title="{if $kw['type']==1}等于{elseif $kw['type']==2}包含{elseif $kw['type']==3}正则{/if}">{$kw['content']}</p>&nbsp;
												{if $kw['type'] == 4}<p class="form-control-static keyword-tag" data-toggle="tooltip" data-placement="top" title="托管">优先级在{$row['displayorder']}之下直接生效</p>{/if}
												{/loop}
												<p></p>
											</div>
											<div class="form-inline">
											<label for="" class="control-label">回复内容</label>
											<div class="form-controls">
												<p class="form-control-static">
													共{$row['allreply']['sum']}条（{if $row['allreply']['basic'] > 0}{$row['allreply']['basic']}条文字 {/if}{if $row['allreply']['images'] > 0}{$row['allreply']['images']}条图片 {/if}{if $row['allreply']['news'] > 0}{$row['allreply']['news']}条图文 {/if}{if $row['allreply']['music'] > 0}{$row['allreply']['music']}条音乐 {/if}{if $row['allreply']['voice'] > 0}{$row['allreply']['voice']}条语音 {/if}{if $row['allreply']['video'] > 0}{$row['allreply']['video']}条视频 {/if}{if $row['allreply']['wxcard'] > 0}{$row['allreply']['wxcard']}条卡券{/if}）
												</p>
											</div>
										</div>
									</div>
								</td>
								<td class="vertical-middle">
									<label>
										<div class="switch {if $row['status']} switchOn{/if}" id="key-{$row['id']}" ng-click="changeStatus({$row[id]})"></div>
									</label>
								</td>
								<td class="vertical-middle text-left">
									<a href="{php echo url('platform/autoreply/post', array('m' => $m, 'rid' => $row['id']))}" class="color-default keyword-link">编辑</a>
									<a href="{php echo url('platform/autoreply/delete', array('m' => $m, 'rid' => $row['id']))}" onclick="return confirm('删除规则将同时删除关键字与回复，确认吗？');return false;" class="color-default keyword-link">删除</a>
									<!-- <a class="color-default keyword-link" href="{php echo url('platform/stat/trend', array('id' => $row['id'], 'm' => $row['module']))}"><i class="fa fa-bar-chart-o"></i> 使用率走势</a> -->
									{if $row['options']}
									<div class="btn-group">
										<button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown">
											功能选项
											<span class="caret"></span>
										</button>
										<ul class="dropdown-menu" style="min-width:0px;">
											{loop $row['options'] $opt}
												<li><a href="{$opt['url']}">{$opt['title']}</a></li>
											{/loop}
										</ul>
									</div>
									{/if}
								</td>
							</tr>
						</table>
						{/loop}
						<div>
							<label class="checkbox-inline" style="margin-top:-30px;margin-left:17px"><input type="checkbox" name="select_all" id="select_all" value="1"/></label>
							<input type="submit" class="btn btn-danger" value="删除" onclick="if(!confirm('确定删除选中的规则吗？')) return false;"/>
							<input type="hidden" name="token" value="{$_W['token']}"/>
						</div>
					{else}
						<p class="text-center">暂无数据</p>
					{/if}
				</form>
				{$pager}
			</div>
		</div>
	</div>
</div>
<script>
require(['bootstrap', 'angular'], function($){
	$(function () {
		$('[data-toggle="tooltip"]').tooltip();
		$('#select_all').click(function(){
			$('#form1 :checkbox').prop('checked', $(this).prop('checked'));
		});
		$('#form1 :checkbox').click(function(){
			if(!$(this).prop('checked')) {
				$('#select_all').prop('checked', false);
			} else {
				var flag = 0;
				$('#form1 :checkbox[name="rid[]"]').each(function(){
					if(!$(this).prop('checked') && !flag) {
						flag = 1;
					}
				});
				if(flag) {
					$('#select_all').prop('checked', false);
				} else {
					$('#select_all').prop('checked', true);
				}
			}
		});
	});
	angular.bootstrap(document, ['replyFormApp']);
});
</script>

{elseif $m == 'special'}
<div class="right-contnt" ng-controller="SpecialDisplay" ng-cloak>
	<div class="NoKeyword-list">
		<div class="we7-tables">
			<table class="we7-table">
				<col width="160px"/>
				<col />
				<col width="120px"/>
				<col width="180px"/>
				<tr>
					<th class="text-left">类型</th>
					<th class="text-left">关键字</th>
					<th>状态</th>
					<th class="text-left">操作</th>
				</tr>
				{loop $mtypes $name $title}
				<tr>
					<td class="text-left">
						{$title}
					</td>
					<td class="text-left">
						{$setting[$name]['keyword']}
					</td>
					<td class="vertical-middle">
						<label>
							<input name="" class="form-control" value="{if !empty($setting[$name]['type'])}1{else}0{/if}" data-type="{$name}" type="checkbox"  style="display: none;">
							<div ng-class="switch_class['{$name}']" ng-click="changestatus('{$name}')"></div>
						</label>
					</td>
					<td class="vertical-middle text-left">
						<a href="{php echo url('platform/autoreply/post', array('m' => 'special', 'type' => $name))}" class="color-default keyword-link">编辑</a>
					</td>
				</tr>
				{/loop}
			</table>
		</div>
	</div>
</div>
<script>
	$(function() {
		angular.module('replyFormApp').value('config', {
			{loop $mtypes $name $title}
				'{$name}' : '{$setting[$name]['type']}',
			{/loop}
			'url' : '{php echo url('platform/autoreply/change_status')}'
		});
		angular.bootstrap(document, ['replyFormApp']);
	});
</script>
{elseif $m == 'system'}
<form class="form form-horizontal" action="" method="post" ng-controller="SystemDisplay" ng-cloak>
	<input type="hidden" name="id" value="{$rule['rule'][id]}">
	<div class="panel panel-default">
		<div class="panel-heading">
			系统回复
		</div>
		<div class="panel-body">
			<div class="form-group">
				<label class="col-xs-12 col-sm-3 col-md-2 control-label">欢迎信息关键字:</label>
				<div class="col-sm-9 col-xs-12" style="position:relative">
					<div class="input-group">
						<input type="text" name="welcome" class="form-control" id="welcomeinput" value="{$setting['welcome']}" placeholder="可根据关键字直接关联指定的回复规则" autocomplete="off" />
						<div class="input-group-btn">
							<span class="btn btn-primary" id="welcome_search"><i class="fa fa-search"></i> 搜索</span>
						</div>
					</div>
					<div id="welcome_menu" style="width:100%;position:absolute;top:32px;left:16px;display:none;z-index:10000">
						<ul class="dropdown-menu" style="display:block;width:91%;height:400px;overflow-y:scroll;"></ul>
					</div>
					<div class="help-block">设置用户添加公众帐号好友时，发送的欢迎信息。<a href="javascript:;" id="welcome"><i class="fa fa-github-alt"></i> 表情</a></div>
					<div class="help-block">
						指定用户添加公众帐号好友时，发送的欢迎信息, 你可以在这里输入关键字, 那么用户添加公众号好友时就相当于发送这个内容至微擎系统<br>
						这个过程是程序模拟的, 比如这里添加关键字: 欢迎关注, 那么用户添加公众号好友时, 微擎系统相当于接受了粉丝用户的消息, 内容为"欢迎关注"
					</div>
				</div>
			</div>
			<div class="form-group">
				<label class="col-xs-12 col-sm-3 col-md-2 control-label">默认回复关键字:</label>
				<div class="col-sm-9 col-xs-12">
					<div class="input-group">
						<input type="text" name="default" class="form-control" id="defaultinput" value="{$setting['default']}" placeholder="可根据关键字直接关联指定的回复规则" />
						<div class="input-group-btn">
							<span class="btn btn-primary search" id="default_search"><i class="fa fa-search"></i> 搜索</span>
						</div>
					</div>
					<div id="default_menu" style="width:100%;position:absolute;top:32px;left:16px;display:none;z-index:10000">
						<ul class="dropdown-menu" style="display:block;width:91%;height:400px;overflow-y:scroll"></ul>
					</div>
					<div class="help-block">当系统不知道该如何回复粉丝的消息时，默认发送的内容。<a href="javascript:;" id="default"><i class="fa fa-github-alt"></i> 表情</a></div>
					<div class="help-block">
						指定系统不知道该如何回复粉丝的消息时，发送的默认信息, 你可以在这里输入关键字, 那么系统不知道该如何回复粉丝的消息时就相当于发送这个内容至微擎系统<br>
						这个过程是程序模拟的, 比如这里添加关键字: ￥@%&%#@*, 系统不知道该如何回复粉丝的消息, 微擎系统相当于接受了粉丝用户的消息, 内容为"￥@%&%#@*"
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="form-group">
		<div class="col-sm-12">
			<input name="submit" type="submit" value="提交" class="btn btn-primary col-lg-1" />
			<input type="hidden" name="token" value="{$_W['token']}" />
		</div>
	</div>
</form>
</div>
<script>
	util.emotion($("#default"), $("#defaultinput")[0]);
	util.emotion($("#welcome"), $("#welcomeinput")[0]);
	function select_keyword(clickid, menuid, inputid){
		$(clickid).click(function(){
			var search_value = $(inputid).val();
			$('body').append('<div class="layer_bg"></div>');
			$('.layer_bg').height($(document).height());
			$('.layer_bg').css({width : '100%', position : 'absolute', top : '0', left : '0', 'z-index' : '0'});
			$.post("{php echo url('platform/special/search_key')}", {'key_word' : search_value}, function(data){
				var data = $.parseJSON(data);
				var total = data.length;
				var html = '';
				if(total > 0) {
					for(var i = 0; i < total; i++) {
						html += '<li><a href="javascript:;">' + data[i] + '</a></li>';
					}
				} else {
					html += '<li><a href="javascript:;" class="no-result">没有匹配到您输入的关键字</a></li>';
				}
				$(menuid + ' ul').html(html);
				$(menuid + ' ul li a[class!="no-result"]').click(function(){
					$('.layer_bg').remove();
					$(inputid).val($(this).html());
					$(menuid).hide();
				});
				$(menuid).show();
			});
			$('.layer_bg').click(function(){
				$(menuid).hide();
				$(this).remove();
			});

		});
		$(inputid).keydown(function(event){
			if(event.keyCode == 13){
				$(clickid).click();
				return false;
			}
		});
	}
	select_keyword('#welcome_search', '#welcome_menu', '#welcomeinput');
	select_keyword('#default_search', '#default_menu', '#defaultinput');
	angular.bootstrap(document, ['replyFormApp']);
</script>
{/if}
{template 'common/footer'}