{template 'common/header'}
<div class="right-contnt">
	<div class="new-keyword">
		<ol class="breadcrumb we7-breadcrumb">
			<a href=""><i class="fa fa-chevron-circle-left"></i> </a>
			<li>
				<a href="{url 'platform/autoreply' array('m' => $m)}">{$module['title']}管理</a>
			</li>
			<li>
				{if empty($rid)}<a href="{url 'platform/autoreply/post' array('m' => $m)}">新建{$module['title']}</a></li>{/if}
				{if !empty($rid)}<a href="{php echo url('platform/autoreply/post', array('m' => $m, 'rid' => $rid))}">编辑{$module['title']}</a></li>{/if}
			</li>
		</ol>
		<div class="we7-form" id="js-reply-form" ng-controller="replyForm" ng-cloak>
			<form id="reply-form" action="{php echo url('platform/autoreply/post', array('m' => $m, 'rid' => $rid))}" method="post" enctype="multipart/form-data">
			<input type="hidden" name="rid" value="{$rid}" />
			<div class="form-group">
				<label for="" class="control-label">规则名称</label>
				<div class="form-controls">
					<input type="text" class="form-control" placeholder="请输入回复规则的名称" name="rulename" value="{if empty($reply['name']) && !empty($_GPC['name'])}{$_GPC['name']}{else}{$reply['name']}{/if}">
					<span class="help-block">您可以给这组触发关键字规则起一个名字, 方便下次修改和查看. </span>
				</div>
			</div>
			<div class="form-group">
				<label for="" class="control-label">全局置顶</label>
				<label class="radio-inline">
					<input type="radio" name="istop" ng-model="reply.entry.istop" style="display:block" ng-value="1" value="1" {if intval($reply['displayorder'] >= 255)} checked="checked"{/if}>是
				</label>
				<label class="radio-inline">
					<input type="radio" name="istop" ng-model="reply.entry.istop" style="display:block" ng-value="0" value="0" {if intval($reply['displayorder'] < 255)} checked="checked"{/if}>否
				</label>
			</div>
			<div class="form-group" ng-show="reply.entry.istop == 0">
				<label for="" class="control-label">回复优先级</label>
				<div class="form-controls">
				<input type="number" min="0" max="254" name="displayorder_rule" style="width:200px" value="{if intval($reply['displayorder']) < 255}{$reply['displayorder']}{/if}" placeholder="输入这条回复规则的优先级">
				<span class="help-block">
					规则优先级，越大则越靠前，最大不得超过254
				</span>
				</div>
			</div>
			<div class="form-group">
				<label for="" class="control-label"></label>
				<div class="form-controls color-default">
					<a href="javascript:;">展开高级设置<i class="fa fa-chevron-down"></i></a>
				</div>
			</div>
			<div class="form-group">
				<input type="hidden" name="keywords">
				<label for="" class="control-label">触发关键字</label>
				<div class="form-controls">
					<div class="form-inline">
						<select name="trigger_type" class="we7-select">
							<option value="">精准触发</option>
							<option value="">模糊触发</option>
						</select>
						<input type="text" class="keyword-input form-control" max="30" id="keywordinput" ng-model="trigger.items.default" onblur="checkKeyWord($(this));">
						<span><a href="javascript:;" id="keyword-emoji"><i class="fa fa-github-alt"></i> 表情</a></span>
						<span class="help-block"></span>
					</div>
					
					<span class="help-block">多个关键字请使用逗号隔开，如天气，今日天气</span>
				</div>
				<div class="form-group">
					<label class="col-xs-12 col-sm-3 col-md-2 control-label"><!-- 高级触发列表 --></label>
					<div class="col-sm-9">
						<div class="panel panel-default tab-content">
							<div class="panel-heading">
								<ul class="nav nav-pills">
									<li class="active"><a href="#contains" role="tab" data-toggle="tab">包含关键字</a></li>
									<li><a href="#regexp" role="tab" data-toggle="tab">正则表达式模式匹配</a></li>
									<li><a href="#trustee" role="tab" data-toggle="tab">直接接管</a></li>
								</ul>
							</div>
							<ul class="tab-pane list-group active" id="contains">
								<li class="list-group-item row" ng-repeat="entry in trigger.items.contains">
									<div class="col-xs-12 col-sm-8">
										<input type="text" class="form-control keyword-input" ng-hide="entry.saved" placeholder="{{entry.label}}" ng-model="entry.content" onblur="checkKeyWord($(this));" />
										<span class="help-block"></span>
										<p class="form-control-static" ng-show="entry.saved" ng-bind="entry.content"></p>
									</div>
									<div class="col-sm-4">
										<div class="btn-group">
											<a href="javascript:;" class="btn btn-default" ng-click="trigger.saveItem(entry);">{{entry.saved ? '编辑' : '保存'}}</a>
											<a href="javascript:;" class="btn btn-default" ng-click="trigger.removeItem(entry);">删除</a>
										</div>
									</div>
								</li>
							</ul>
							<ul class="tab-pane list-group" id="regexp">
								<li class="list-group-item row" ng-repeat="entry in trigger.items.regexp">
									<div class="col-xs-12 col-sm-8">
										<input type="text" class="form-control keyword-input" ng-hide="entry.saved" placeholder="{{entry.label}}" ng-model="entry.content" onblur="checkKeyWord($(this));" />
										<span class="help-block"></span>
										<p class="form-control-static" ng-show="entry.saved" ng-bind="entry.content"></p>
									</div>
									<div class="col-sm-4">
										<div class="btn-group">
											<a href="javascript:;" class="btn btn-default" ng-click="trigger.saveItem(entry);">{{entry.saved ? '编辑' : '保存'}}</a>
											<a href="javascript:;" class="btn btn-default" ng-click="trigger.removeItem(entry);">删除</a>
										</div>
									</div>
								</li>
							</ul>
							<ul class="tab-pane list-group" id="trustee">
								<li class="list-group-item row" ng-repeat="entry in trigger.items.trustee">
									<div class="col-xs-12 col-sm-8">
										<p class="form-control-static">符合优先级条件时, 这条回复将直接生效</p>
									</div>
									<div class="col-sm-4">
										<a href="javascript:;" class="btn btn-default" ng-click="trigger.removeItem(entry);">取消接管</a>
									</div>
								</li>
							</ul>
							<div class="panel-footer">
								<a href="javascript:;" class="btn btn-default" ng-click="trigger.addItem();" ng-bind="'添加' + trigger.labels[trigger.active]"></a>
								<span class="help-block" ng-bind-html="trigger.descriptions[trigger.active]"></span>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="form-group">
				<label for="" class="control-label">是否开启</label>
				<div class="form-controls">
					<label>
						<input type="hidden" name="status" class="form-control" ng-model="reply.status">
						<div class="switch" ng-class="{'switchOn': reply.status}" ng-click="trigger.changeStatus()"></div>
					</label>
					<span class="help-block">您可以选择临时禁用这条回复.</span>
				</div>
			</div>
			{php echo module_build_form('autoreply', $rid)}
			<input type="hidden" name="token" value="{$_W['token']}" />
			<input type="submit" name="submit" value="发&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;布" class="btn btn-primary we7-padding-horizontal" style="padding: 6px 50px;"/>
		</div>
	</div>
</div>
<script>
require(['angular.sanitize', 'bootstrap', 'underscore', 'util'], function(angular, $, _, util){
	angular.module('replyFormApp', ['ngSanitize']);
	angular.module('replyFormApp').controller('replyForm',['$scope', '$http', function($scope, $http){
		$scope.reply = {
			advTrigger: false,
			status: false,
			entry: {php echo json_encode($reply)},
		};
		$scope.trigger = {
			descriptions: {
				contains: '用户进行交谈时，对话中包含上述关键字就执行这条规则。',
				regexp: '用户进行交谈时，对话内容符合述关键字中定义的模式才会执行这条规则。<br/><strong>注意：如果你不明白正则表达式的工作方式，请不要使用正则匹配</strong> <br/><strong>注意：正则匹配使用MySQL的匹配引擎，请使用MySQL的正则语法</strong> <br /><strong>示例: </strong><br/><em>^微信</em>匹配以“微信”开头的语句<br /><em>微信$</em>匹配以“微信”结尾的语句<br /><em>^微信$</em>匹配等同“微信”的语句<br /><em>微信</em>匹配包含“微信”的语句<br /><em>[0-9\.\-]</em>匹配所有的数字，句号和减号<br /><em>^[a-zA-Z_]$</em>所有的字母和下划线<br /><em>^[[:alpha:]]{3}$</em>所有的3个字母的单词<br /><em>^a{4}$</em>aaaa<br /><em>^a{2,4}$</em>aa，aaa或aaaa<br /><em>^a{2,}$</em>匹配多于两个a的字符串',
				trustee: '如果没有比这条回复优先级更高的回复被触发，那么直接使用这条回复。<br/><strong>注意：如果你不明白这个机制的工作方式，请不要使用直接接管</strong>',
			},
			labels: {
				contains: '包含关键字',
				regexp: '正则表达式模式',
				trustee: '直接接管操作',
			},
			active: 'contains',
			items: {
				default: '',
				contains: [],
				regexp: [],
				trustee: [],
			}
		};
		if($scope.reply.entry) {
			$scope.reply.entry.istop = $scope.reply.entry.displayorder >= 255 ? 1 : 0;
			if($scope.reply.entry.keywords) {
				angular.forEach($scope.reply.entry.keywords, function(v, k){
					if(v.type == '1') {
						this.default += (v.content + ',');
					}
					if(v.type == '2') {
						this.contains.push({content: v.content, label: '请输入' + $scope.trigger.labels.contains, saved: true});
					}
					if(v.type == '3') {
						this.regexp.push({content: v.content, label: '请输入' + $scope.trigger.labels.regexp, saved: true});
					}
					if(v.type == '4') {
						this.trustee.push({});
					}
				}, $scope.trigger.items);
				if($scope.trigger.items.default.length > 1) {
					$scope.trigger.items.default = $scope.trigger.items.default.slice(0, $scope.trigger.items.default.length - 1);
				}
				if($scope.trigger.items.contains.length > 0 || $scope.trigger.items.regexp.length > 0 || $scope.trigger.items.trustee.length > 0) {
					$scope.reply.advTrigger = true;
				}
				if($scope.trigger.items.contains.length > 0) {
					$('a[data-toggle="tab"]').eq(0).tab('show');
					$scope.trigger.active = 'contains';
				} else if($scope.trigger.items.regexp.length > 0) {
					$('a[data-toggle="tab"]').eq(1).tab('show');
					$scope.trigger.active = 'regexp';
				} else if($scope.trigger.items.trustee.length > 0) {
					$('a[data-toggle="tab"]').eq(2).tab('show');
					$scope.trigger.active = 'trustee';
				}
			}
		}else {
			$scope.reply.entry = {
				istop: 0,
				displayorder: '',
				id: '',
				keywords: [],
				module: '',
				name: '',
				status: 1,
				uniacid: {php echo json_encode($_W['uniacid'])}
			};
		}
		$scope.trigger.addItem = function(){
			var type = $scope.trigger.active;
			if(type != 'trustee') {
				$scope.trigger.items[type].push({content: '', label: '请输入' + $scope.trigger.labels[type], saved: false});
			} else {
				if($scope.trigger.items.trustee.length == 0) {
					$scope.trigger.items.trustee.push({type:4, content:''});
				}
			}
		};
		$scope.trigger.changeStatus = function(){
			$scope.reply.status = !$scope.reply.status;
		};
		$scope.trigger.saveItem = function(item){
			item.saved = !item.saved;
		};
		$scope.trigger.removeItem = function(item) {
			var type = $scope.trigger.active;
			$scope.trigger.items[type] = _.without($scope.trigger.items[type], item);
		};
		if($.isFunction(window.initReplyController)) {
			window.initReplyController($scope, $http);
		};
		$('#reply-form').submit(function(){
			if($.trim($(':text[name="rulename"]').val()) == '') {
				util.message('必须输入回复规则名称');
				return false;
			}
			var val = [];
			if($scope.trigger.items.default != '') {
				var kws = $scope.trigger.items.default.replace('，', ',').split(',');
				kws = _.union(kws);
				angular.forEach(kws, function(v){
					if(v != '') {
						val.push({type: 1, content: v});
					}
				}, val);
			}
			angular.forEach($scope.trigger.items, function(v, name){
				var flag = true;
				if(name != 'default' && v.length > 0) {
					if(name == 'contains' || name == 'regexp'){
						angular.forEach(v, function(value){
							if(value.content.trim() != '') {
								this.push({
									content: value.content,
									type: name == 'contains' ? 2 : 3
								});
							}
						}, val);
					}
					if(name == 'trustee'){
						angular.forEach(v, function(value){
							this.push({type:4, content:''});
						}, val);
					}
				}
			}, val);
			//待完善
			// if(val.length == 0 && $scope.trigger.active != 'trustee') {
			// 	util.message('请输入有效的触发关键字.');
			// 	return false;
			// }
			val = angular.toJson(val);
			$(':hidden[name="keywords"]').val(val);
			if($.isFunction(window.validateReplyForm)) {
				return window.validateReplyForm(this, $, _, util, $scope, $http);
			}
			return true;
		});
		$('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
			$scope.trigger.active = e.target.hash.replace(/#/, '');
			$scope.$digest();
		});
		util.emotion($("#keyword-emoji"), $('#keywordinput'), function(txt, elm, target){
			$scope.trigger.items.default = $(target).val();
		});

	}]).filter('nl2br', function($sce){
		return function(text) {
			return text ? $sce.trustAsHtml(text.replace(/\n/g, '<br/>')) : '';
		};
	}).directive('ngInvoker', function($parse){
		return function (scope, element, attr) {
			scope.$eval(attr.ngInvoker);
		};
	}).directive('ngMyEditor', function(){
		var editor = {
			'scope' : {
				'value' : '=ngMyValue'
			},
			'template' : '<textarea id="editor" style="height:600px;width:100%;"></textarea>',
			'link' : function ($scope, element, attr) {
				if(!element.data('editor')) {
					editor = UE.getEditor('editor', ueditoroption);
					element.data('editor', editor);
					editor.addListener('contentChange', function() {
						$scope.value = editor.getContent().replace(/\&quot\;/g, '"');
						$scope.$root.$$phase || $scope.$apply('value');
					});
					$(element).parents('form').submit(function() {
						if (editor.queryCommandState('source')) {
							editor.execCommand('source');
						}
					});
					editor.addListener('ready', function(){
						if (editor && editor.getContent() != $scope.value) {
							editor.setContent($scope.value);
						}
						$scope.$watch('value', function (value) {
							if (editor && editor.getContent() != value) {
								editor.setContent(value ? value : '');
							}
						});
					});
				}
			}
		};
		return editor;
	});
	angular.bootstrap($('#js-reply-form'), ['replyFormApp']);


	// 检测规则是否已经存在
	window.checkKeyWord = function(key) {
		var keyword = key.val().trim();
		if (keyword == '') {
			key.next().next().text('');
			return false;
		}
		var type = key.attr('data-type');
		var wordIndex = key.index('.keyword-input');
		var isLeagl = true;
		$('.keyword-input').each(function(index) {
			var currentWord = $(this).val().trim();
			if (keyword == currentWord && wordIndex != index) {
				isLeagl = false;
				return false;
			}
		});
		if (isLeagl === false) {
			key.next().next().text('');
			util.message('该关键字已重复存在于当前规则中.');
			return false;
		}

		$.post(location.href, {keyword:keyword}, function(resp){
			if(resp != 'success') {
				var rid = $('input[name="rid"]').val();
				var rules = JSON.parse(resp);
				var url = "{php echo url('platform/autoreply/post', array('m' => $_GPC['m']));}";
				var ruleurl = '';
				for (rule in rules) {
					if (rid != rules[rule].id) {
						ruleurl += "<a href='" + url + "&rid=" + rules[rule].id + "' target='_blank'><strong class='text-danger'>" + rules[rule].name + "</strong></a>&nbsp;";
					}
				}
				if (ruleurl != '') {
					key.next().next().html('该关键字已存在于 ' + ruleurl + ' 规则中.');
				}
			} else {
				key.next().next().text('');
			}
		});
	}

	$('.keyword-input').each(function() {
		$(this).attr('data-type', 'keyword');
	});
});
</script>
{template 'common/footer'}