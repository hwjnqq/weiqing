{template 'common/header'}
<div class="we7-page-title">
	素材定时群发
</div>
<ul class="we7-page-tab">
	<li {if $_GPC['a'] == 'mass'  && $do == 'list'}class="active"{/if}>
		<a href="{php echo url('platform/mass/')}" >素材定时群发</a>
	</li>
	<li {if $_GPC['a'] == 'mass' && $do == 'send'}class="active"{/if}>
		<a href="{php echo url('platform/mass/send')}">定时群发记录</a>
	</li>
</ul>
<div class="mass-send" id="js-mass-send" ng-controller="MassSend" ng-cloak>
	<table class="tabel we7-table">
		<col />
		<tr>
			<th>消息类型</th>
			<th>接收用户组</th>
			<th>预计发送时间</th>
			<th>实际发送时间</th>
			<th>发送人数</th>
			<th>状态</th>
			<th class="hidden">操作</th>
		</tr>
		{loop $lists $list}
		<tr>
			<td>
				<a href="{php echo url('material/display/list', array('type' => $li['msgtype'], 'id' => $li['attach_id']));}" target="_blank">
					{$types[$list['msgtype']]}
				</a>
			</td>
			<td>{$list['groupname']}</td>
			<td>{php echo date('Y-m-d H:i', $list['sendtime']);}</td>
			<td>{if $list['status'] == 0 || $list['status'] == 2}{php echo date('Y-m-d H:i', $list['finalsendtime']);}{else}---{/if}</td>
			<td>{if $list['groupid'] == '-1'}全部粉丝{else}{$list['fansnum']}{/if}</td>
			<td>
				{if !$list['status']}
					<span class="label label-success">已发送</span>
				{elseif $list['status'] == 1}
					<span class="label label-warning">未发送</span>
				{elseif $list['status'] == 2}
					<span class="label label-danger">发送失败</span>
				{/if}
			</td>
			<td class="hidden">
				{if $list['type'] != 1}
					{if !$list['cron_id'] && $list['sendtime'] > TIMESTAMP}
					<a href="{php echo url('material/mass/cron', array('id' => $list['id']));}" class="btn btn-danger btn-sm">同步到云服务</a>
					{/if}
					<a href="javascript:;" id="{$list['id']}" class="btn btn-default mass-log" ng-mouseover="showLog({$list['id']})" ng-mouseleave="hideLog({$list['id']})">日志</a>
				{/if}
			</td>
		</tr>
		{/loop}
	</table>
	<div class="pull-right we7-padding-top"> 
		{$pager}
	</div>
</div>
<script>
	angular.module(['massApp']).controller('MassSend', ['$scope', '$http', function($scope, $http){
		$scope.showLog = function(id){
			var tid = parseInt(id);
			var obj = $('#'+tid);
			$http.post("{php echo url('utility/cron/log');}", {tid: tid, type: 'mass', module: 'task'})
				.success(function(data) {
					data = angular.toJson(data);
					var html = '';
					if(!data.message || data.message.items.length == 0) {
						html = '<tr><td class="text-center"><i class="fa fa-info-circle"></i> 暂无数据</td></tr>';
					} else{
						$.each(data.message.items, function(k, v){
							html += '<tr><td>' + v.createtime + ' ' + v.note + '</td></tr>';
						});
					}
					obj.popover({
						'html':true,
						'placement':'left',
						'trigger':'manual',
						'title':'触发日志',
						'content':'<table class="table-cron table">' + html + '</table>'
					});
					obj.popover('toggle');
				});
		};
		$scope.hideLog = function(id){
			var tid = parseInt(id);
			var obj = $('#'+tid);
			obj.popover('toggle');
		}
	}]);
	angular.bootstrap($('#js-mass-send'), ['massApp']);
</script>
{template 'common/footer'}