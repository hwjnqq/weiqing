{template 'common/header'}
<div class="keyword-list">
{if in_array($m, $sysmods)}
	<div class="we7-page-title">
		自动回复
	</div>
	<ul class="we7-page-tab">
		<li {if $m == 'keyword' || $m == ''}class="active" {/if}><a href="{url 'platform/reply' array('m' => 'keyword')}">关键字自动回复 </a></li>
		<li {if $m == 'special'}class="active"{/if}><a href="{url 'platform/reply' array('m' => 'special')}">非文字自动回复</a></li>
			<li {if $m == 'welcome'}class="active"{/if}><a href="{url 'platform/reply' array('m' => 'welcome')}">首次访问自动回复</a></li>
			<li {if $m == 'default'}class="active"{/if}><a href="{url 'platform/reply' array('m' => 'default')}">默认回复</a></li>
	</ul>
{else}
	<ul class="we7-page-tab">
		<li class="active"><a href="{url 'platform/reply' array('m' => $m)}">关键字链接入口 </a></li>
		<li><a href="javascript:;">微官网入口设置</a></li>
		<li><a href="javascript:;">个人中心入口设置</a></li>
	</ul>	
{/if}
{if $m == 'keyword' || !in_array($m, $sysmods)}
	<div id="js-keyword-display" ng-controller="KeywordDisplay" ng-cloak>
		<div class="keyword-list-head">
			<form action="./index.php" method="get" class="form-horizontal" role="form">
				<input type="hidden" name="c" value="platform">
				<input type="hidden" name="a" value="reply">
				<input type="hidden" name="m" value="{$_GPC['m']}" />
				<input type="hidden" name="status" value="{$status}" />
				<div class="keyword-list-head">
					<div class="input-group col-sm-4 pull-left">
						<input class="form-control" name="keyword" type="text" value="{$_GPC['keyword']}" placeholder="输入规则名称">
						<span class="input-group-btn"><button class="btn btn-default"><i class="fa fa-search"></i></button></span>
					</div>
					<div class="pull-right">
						<a href="{url 'platform/reply/post' array('m' => $m)}" class="btn btn-primary">+添加关键字回复</a>
						{if in_array($m, $sysmods)}<a href="{url 'platform/reply/post' array('m' => 'apply')}" class="btn btn-danger">+添加应用关键字</a>{/if}
					</div>
				</div> 
			</form>
		</div>
		{if in_array($m, $sysmods)}
		<div class="btn-group we7-btn-group we7-padding-vertical btn-group-justified">
			<a href="{url 'platform/reply/display' array('m' => 'keyword')}" class="btn {if !$_GPC[type]}active{/if}">全部</a>
			<a href="{url 'platform/reply/display' array('m' => 'keyword', 'type' => 'news')}" class="btn {if $_GPC[type] == 'news'}active{/if}">回复图文</a>
			<a href="{url 'platform/reply/display' array('m' => 'keyword', 'type' => 'apply')}" class="btn {if $_GPC[type] == 'apply'}active{/if}">回复模块</a>
			<a href="{url 'platform/reply/display' array('m' => 'keyword', 'type' => 'voice')}" class="btn {if $_GPC[type] == 'voice'}active{/if}">回复语音</a>
			<a href="{url 'platform/reply/display' array('m' => 'keyword', 'type' => 'basic')}" class="btn {if $_GPC[type] == 'basic'}active{/if}">回复文字</a>
			<a href="{url 'platform/reply/display' array('m' => 'keyword', 'type' => 'music')}" class="btn {if $_GPC[type] == 'music'}active{/if}">回复音乐</a>
			<a href="{url 'platform/reply/display' array('m' => 'keyword', 'type' => 'images')}" class="btn {if $_GPC[type] == 'images'}active{/if}">回复图片</a>
			<a href="{url 'platform/reply/display' array('m' => 'keyword', 'type' => 'video')}" class="btn {if $_GPC[type] == 'video'}active{/if}">回复视频</a>
		</div>
		{/if}
		<div class="table we7-tables {if !in_array($m, $sysmods)} we7-padding-vertical{/if}">
			<form action="{php echo url('platform/reply/delete');}" method="post" role="form" class="form we7-form" id="form1">
				<input type="hidden" name="m" value="{$m}"/>
				{if !empty($replies)}
					{loop $replies $row}
					<table class="table we7-table">
						<col />
						<col width="120px"/>
						<col width="150px"/>
						<tr>
							<th class="text-left">
								<div class="pull-left">
									<input id='rid-{$row['id']}' type="checkbox" name='rid[]' value="{$row['id']}"/>
									<label for="rid-{$row['id']}">规则名：{$row['name']}</label>
								</div>
								<span class="pull-right">
									{if $row['displayorder'] > 0}
										{if $row['displayorder'] == '255'}
											<span class="label label-primary">置顶</span>
										{else}
											<span class="label label-info">优先级 {$row['displayorder']}</span>
										{/if}
									{/if}
									{if $row['status'] == '0'}<span class="label label-danger">已禁用</span>{/if}
								</span>
							</th>
							<th>是否开启</th>
							<th class="text-left">操作</th>
						</tr>
						<tr>
							<td class="text-left">
								<div class="we7-form">
									<div class="form-inline">
										<label for="" class="control-label">关&nbsp;键&nbsp;字</label>
										<div class="form-controls">
											{loop $row['keywords'] $kw}
											<p class="form-control-static keyword-tag" data-toggle="tooltip" data-placement="bottom" title="{if $kw['type']==1}等于{elseif $kw['type']==2}包含{elseif $kw['type']==3}正则{/if}">{$kw['content']}</p>&nbsp;
											{if $kw['type'] == 4}<p class="form-control-static keyword-tag" data-toggle="tooltip" data-placement="bottom" title="托管">优先级在{$row['displayorder']}之下直接生效</p>{/if}
											{/loop}
											<p></p>
										</div>
										<div class="form-inline">
										<label for="" class="control-label">回复内容</label>
										<div class="form-controls">
											<p class="form-control-static">
											{if $row['module'] == 'basic' || $row['module'] == 'news' || $row['module'] == 'music' || $row['module'] == 'images' || $row['module'] == 'voice' || $row['module'] == 'video' || $row['module'] == 'wxcard' || $row['module'] == 'reply'}
												共{$row['allreply']['sum']}条（{if $row['allreply']['basic'] > 0}{$row['allreply']['basic']}条文字 {/if}{if $row['allreply']['images'] > 0}{$row['allreply']['images']}条图片 {/if}{if $row['allreply']['news'] > 0}{$row['allreply']['news']}条图文 {/if}{if $row['allreply']['music'] > 0}{$row['allreply']['music']}条音乐 {/if}{if $row['allreply']['voice'] > 0}{$row['allreply']['voice']}条语音 {/if}{if $row['allreply']['video'] > 0}{$row['allreply']['video']}条视频 {/if}{if $row['allreply']['wxcard'] > 0}{$row['allreply']['wxcard']}条卡券{/if}）
											{else}
												模块
											{/if}
											</p>
										</div>
									</div>
								</div>
							</td>
							<td class="vertical-middle">
								<label>
									<div class="switch {if $row['status']} switchOn{/if}" id="key-{$row['id']}" ng-click="changeStatus({$row[id]})"></div>
								</label>
							</td>
							<td class="vertical-middle text-left">
								{if $row['module'] == 'basic' || $row['module'] == 'news' || $row['module'] == 'music' || $row['module'] == 'images' || $row['module'] == 'voice' || $row['module'] == 'video' || $row['module'] == 'wxcard' || $row['module'] == 'reply'}
								<a href="{php echo url('platform/reply/post', array('m' => $m, 'rid' => $row['id']))}" class="color-default keyword-link">编辑</a>
								{/if}
								<a href="{php echo url('platform/reply/delete', array('m' => $m, 'rid' => $row['id']))}" onclick="return confirm('删除规则将同时删除关键字与回复，确认吗？');return false;" class="color-default keyword-link">删除</a>
								<!-- <a class="color-default keyword-link" href="{php echo url('platform/stat/trend', array('id' => $row['id'], 'm' => $row['module']))}"><i class="fa fa-bar-chart-o"></i> 使用率走势</a> -->
								{if $row['options']}
								<!-- <div class="btn-group">
									<button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown">
										功能选项
										<span class="caret"></span>
									</button>
									<ul class="dropdown-menu" style="min-width:0px;">
										{loop $row['options'] $opt}
											<li><a href="{$opt['url']}">{$opt['title']}</a></li>
										{/loop}
									</ul>
								</div> -->
								{/if}
							</td>
						</tr>
					</table>
					{/loop}
					<div>
						<input type="checkbox" name="select_all" id="select_all" value="1" />
						<label for="select_all" class="we7-margin-left">&nbsp;</label>
						<!--<label class="checkbox-inline" style="margin-top:-20px;margin-left:17px"><input type="checkbox" name="select_all" id="select_all" value="1"/></label>-->
						<input type="submit" class="btn btn-danger" value="删除" onclick="if(!confirm('确定删除选中的规则吗？')) return false;"/>
						<input type="hidden" name="token" value="{$_W['token']}"/>
						<div class="pull-right">
							{$pager}
						</div>
					</div>
				{else}
					<p class="text-center we7-margin-top">暂无数据</p>
				{/if}
			</form>
		</div>
	</div>
	<script>
		$(function () {
			$('[data-toggle="tooltip"]').tooltip();
			$('#select_all').click(function(){
				$('#form1 :checkbox').prop('checked', $(this).prop('checked'));
			});
			$('#form1 :checkbox').click(function(){
				if(!$(this).prop('checked')) {
					$('#select_all').prop('checked', false);
				} else {
					var flag = 0;
					$('#form1 :checkbox[name="rid[]"]').each(function(){
						if(!$(this).prop('checked') && !flag) {
							flag = 1;
						}
					});
					if(flag) {
						$('#select_all').prop('checked', false);
					} else {
						$('#select_all').prop('checked', true);
					}
				}
			});
		});
		angular.bootstrap($('#js-keyword-display'), ['replyFormApp']);
	</script>
{elseif $m == 'special'}
	<div class="NoKeyword-list" id="js-special-display" ng-controller="SpecialDisplay" ng-cloak>
		<div class="table we7-tables">
			<table class="table we7-table">
				<col width="160px"/>
				<col />
				<col width="120px"/>
				<col width="180px"/>
				<tr>
					<th class="text-left">类型</th>
					<th class="text-left">关键字</th>
					<th>状态</th>
					<th class="text-left">操作</th>
				</tr>
				{loop $mtypes $name $title}
				<tr>
					<td class="text-left">
						{$title}
					</td>
					<td class="text-left">
						{$setting[$name]['keyword']}
					</td>
					<td class="vertical-middle">
						<label>
							<input name="" class="form-control" value="{if !empty($setting[$name]['type'])}1{else}0{/if}" data-type="{$name}" type="checkbox"  style="display: none;">
							<div ng-class="switch_class['{$name}']" ng-click="changestatus('{$name}')"></div>
						</label>
					</td>
					<td class="vertical-middle text-left">
						<a href="{php echo url('platform/reply/post', array('m' => 'special', 'type' => $name))}" class="color-default keyword-link">编辑</a>
					</td>
				</tr>
				{/loop}
			</table>
		</div>
	</div>
	<script>
		$(function() {
			angular.module('replyFormApp').value('config', {
				{loop $mtypes $name $title}
					'{$name}' : '{$setting[$name]['type']}',
				{/loop}
				'url' : '{php echo url('platform/reply/change_status')}'
			});
			angular.bootstrap($('#js-special-display'), ['replyFormApp']);
		});
	</script>
{elseif $m == 'welcome'}
	<div class="new-keyword" id="welcome" ng-cloak>
		<div class="we7-form" ng-controller="WelcomeDisplay">
			<form id="reply-form" class="form-horizontal form" action="{php echo url('platform/reply/post', array('m' => $m, 'rid' => $rid))}" method="post" enctype="multipart/form-data">
				<div>
					{php echo module_build_form('reply', $ruleid, array('keyword' => false))}
				</div>
				<input type="submit" name="submit"  value="保存" class="btn btn-primary" style="padding: 6px 50px;"/>
				<input type="hidden" name="token" value="{$_W['token']}">
				<input type="hidden" name="m" value="{$m}">
				<input type="hidden" name="type" value="{$type}">
			</form>
		</div>
	</div>
	<script>
		require(['underscore'], function() {
			angular.bootstrap($('#welcome'), ['replyFormApp']);
		});
	</script>
{elseif $m == 'default'}
	<div class="new-keyword" id="default">
		<div id="a" class="we7-form" ng-controller="DefaultDisplay">
			<form id="reply-form" class="form-horizontal form" action="{php echo url('platform/reply/post', array('m' => $m, 'rid' => $rid))}" method="post" enctype="multipart/form-data">
				<div>
					{php echo module_build_form('reply', $ruleid, array('keyword' => false))}
				</div>
				<input type="submit" name="submit"  value="保存" class="btn btn-primary" style="padding: 6px 50px;"/>
				<input type="hidden" name="token" value="{$_W['token']}">
				<input type="hidden" name="m" value="{$m}">
				<input type="hidden" name="type" value="{$type}">
			</form>
		</div>
	</div>
	<script>
		require(['underscore'], function() {
			angular.bootstrap($('#default'), ['replyFormApp']);
		});
	</script>
{/if}
{template 'common/footer'}